{% extends 'compliance/base.html' %}
{% load static %}

{% block title %}Regulatory Calendar{% endblock title %}

{# If your base uses a different head slot, keep this as extra_js; otherwise rename to whatever your base defines (e.g. extra_head). #}
{% block extra_js %}
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
{% endblock extra_js %}

{% block compliance_content %}
  <div class="bg-white rounded-lg shadow p-4 mb-4">
    <form method="get" class="flex flex-wrap items-center gap-2">
      <label class="text-xs text-gray-600">Category</label>
      <select name="category" class="px-2 py-2 border border-gray-200 rounded text-xs bg-white">
        <option value="">All</option>
        {% for value,label in category_choices %}
          <option value="{{ value }}" {% if selected_category == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>

      <label class="text-xs text-gray-600">Status</label>
      <select name="status" class="px-2 py-2 border border-gray-200 rounded text-xs bg-white">
        <option value="">All</option>
        {% for value,label in status_choices %}
          <option value="{{ value }}" {% if selected_status == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>

      <label class="text-xs text-gray-600">Window</label>
      <select name="period" class="px-2 py-2 border border-gray-200 rounded text-xs bg-white">
        <option value="30" {% if selected_period == '30' %}selected{% endif %}>30 days</option>
        <option value="60" {% if selected_period == '60' %}selected{% endif %}>60 days</option>
        <option value="90" {% if selected_period == '90' %}selected{% endif %}>90 days</option>
      </select>

      <button class="px-3 py-2 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">Apply</button>
    </form>
  </div>

  <div class="bg-white rounded-lg shadow p-4">
    <div id="calendar" class="w-full"></div>
    <p class="text-[10px] text-gray-400 mt-2">Click an event for details.</p>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const calendarEl = document.getElementById('calendar');
      const events = {{ events_json|safe }};

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        height: 'auto',
        events: events.map(e => ({
          id: e.id,
          title: e.title,
          start: e.start,
          end: e.end,
          display: 'block',
          color: e.type === 'audit'
            ? '#3B82F6'
            : (e.status === 'Pending' ? '#F59E0B' : '#10B981')
        })),
        eventClick: function (info) {
          const e = events.find(x => String(x.id) === String(info.event.id));
          if (!e) return;
          const details = [
            `Type: ${e.type}`,
            e.category ? `Category: ${e.category}` : null,
            e.status ? `Status: ${e.status}` : null,
            e.priority ? `Priority: ${e.priority}` : null,
            `Start: ${e.start}`,
            `End: ${e.end}`
          ].filter(Boolean).join('\n');
          alert(details);
        }
      });

      calendar.render();
    });
  </script>
{% endblock compliance_content %}
