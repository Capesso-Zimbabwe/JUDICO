{% extends 'communication/base.html' %}

{% block title %}Communication - Messages{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: calc(100vh - 200px);
        min-height: 600px;
        max-height: calc(100vh - 200px);
        background-color: #ffffff;
        border-radius: 0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }
    
    .conversation-list {
        overflow: hidden;
        background-color: #f9fafb;
        border-right: 1px solid #e5e7eb;
        max-width: 350px;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .conversation-item {
        cursor: pointer;
        transition: all 0.2s ease;
        padding: 12px;
        border-bottom: 1px solid #e5e7eb;
        background-color: #ffffff;
        flex-shrink: 0;
    }
    
    .conversation-item:hover {
        background-color: #f3f4f6;
    }
    
    .conversation-item.active {
        background-color: #eff6ff;
        border-right: 3px solid #1e3a8a;
    }
    
    .chat-area {
        display: flex;
        flex-direction: column;
        height: 100%;
        background-color: #ffffff;
        overflow: hidden;
    }
    
    .chat-header {
        background-color: #ffffff;
        position: sticky;
        top: 0;
        z-index: 20;
        border-bottom: 1px solid #e5e7eb;
        padding: 12px 16px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        flex-shrink: 0;
    }
    
    .chat-messages {
        flex: 1;
        overflow: hidden;
        padding: 16px;
        background-color: #fafafa;
        min-height: 0;
        max-height: calc(100vh - 400px);
    }
    
    .message-bubble {
        max-width: 70%;
        margin-bottom: 12px;
        word-wrap: break-word;
        position: relative;
        border-radius: 0;
        padding: 10px 14px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border: 1px solid #e5e7eb;
    }
    
    .message-sent {
        margin-left: auto;
        background-color: #1e3a8a;
        color: #ffffff;
        border-color: #1e3a8a;
    }
    
    .message-received {
        background-color: #ffffff;
        color: #374151;
        border-color: #e5e7eb;
    }
    
    .message-time {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 3px;
        text-align: right;
    }
    
    .message-sender {
        font-size: 12px;
        font-weight: 600;
        color: #6b7280;
        margin-bottom: 3px;
    }
    
    .chat-input {
        background-color: #ffffff;
        padding: 12px 16px;
        position: sticky;
        bottom: 0;
        z-index: 10;
        border-top: 1px solid #e5e7eb;
        flex-shrink: 0;
    }
    
    .chat-input-form {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .chat-input-field {
        flex: 1;
        background-color: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 0;
        padding: 10px 14px;
        font-size: 14px;
        outline: none;
        color: #374151;
        transition: border-color 0.2s ease;
    }
    
    .chat-input-field:focus {
        border-color: #1e3a8a;
        background-color: #ffffff;
    }
    
    .chat-input-field::placeholder {
        color: #9ca3af;
    }
    
    .send-button {
        background-color: #1e3a8a;
        border: none;
        border-radius: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 16px;
    }
    
    .send-button:hover {
        background-color: #1e40af;
        transform: translateY(-1px);
    }
    
    .send-button:disabled {
        background-color: #9ca3af;
        cursor: not-allowed;
        transform: none;
    }
    
    .empty-chat {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        background: transparent;
        color: #9ca3af;
        flex-direction: column;
        gap: 16px;
    }
    
    .conversation-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #1e3a8a;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        font-weight: 600;
        font-size: 14px;
        border: 2px solid #e5e7eb;
    }
    
    .chat-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: #1e3a8a;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        font-weight: 600;
        font-size: 13px;
        border: 2px solid #e5e7eb;
    }
    
    .search-container {
        background-color: #ffffff;
        padding: 12px;
        border-bottom: 1px solid #e5e7eb;
        flex-shrink: 0;
    }
    
    .search-input {
        width: 100%;
        background-color: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 0;
        padding: 8px 12px;
        font-size: 14px;
        outline: none;
        color: #374151;
        transition: border-color 0.2s ease;
    }
    
    .search-input:focus {
        border-color: #1e3a8a;
        background-color: #ffffff;
    }
    
    .conversations-list {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    .conversation-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .conversation-details {
        flex: 1;
        min-width: 0;
    }
    
    .conversation-name {
        font-weight: 600;
        color: #111827;
        font-size: 13px;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .conversation-preview {
        color: #6b7280;
        font-size: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .conversation-time {
        color: #9ca3af;
        font-size: 10px;
        white-space: nowrap;
    }
    
    .unread-badge {
        background-color: #ef4444;
        color: #ffffff;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 600;
        margin-left: auto;
    }
    
    .document-message {
        background-color: #f3f4f6;
        border: 1px solid #e5e7eb;
        border-radius: 0;
        padding: 10px;
        margin-top: 6px;
    }
    
    .document-icon {
        color: #1e3a8a;
        margin-right: 8px;
    }
    
    .document-name {
        font-weight: 500;
        color: #374151;
        font-size: 12px;
    }
    
    .document-size {
        color: #6b7280;
        font-size: 10px;
        margin-top: 2px;
    }
    
    .attachment-button {
        background-color: #f3f4f6;
        border: 1px solid #e5e7eb;
        border-radius: 0;
        padding: 6px 10px;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 13px;
    }
    
    .attachment-button:hover {
        background-color: #e5e7eb;
        color: #374151;
    }
    
    .new-conversation-btn {
        background-color: #1e3a8a;
        color: #ffffff;
        border: none;
        border-radius: 0;
        padding: 10px 16px;
        font-weight: 600;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        margin: 12px;
        width: calc(100% - 24px);
        flex-shrink: 0;
    }
    
    .new-conversation-btn:hover {
        background-color: #1e40af;
        transform: translateY(-1px);
    }
    
    .user-type-badge {
        background-color: #10b981;
        color: #ffffff;
        border-radius: 0;
        padding: 1px 4px;
        font-size: 9px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .user-type-badge.client {
        background-color: #f59e0b;
    }
    
    .user-type-badge.lawyer {
        background-color: #1e3a8a;
    }
    
    /* Modal styling */
    .modal-overlay {
        background-color: rgba(0, 0, 0, 0.5);
    }
    
    .modal-content {
        background-color: #ffffff;
        border-radius: 0;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }
    
    .modal-header {
        border-bottom: 1px solid #e5e7eb;
        padding: 20px 24px;
    }
    
    .modal-body {
        padding: 24px;
    }
    
    .modal-footer {
        border-top: 1px solid #e5e7eb;
        padding: 20px 24px;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }
    
    .btn {
        padding: 8px 16px;
        font-size: 12px;
        font-weight: 600;
        border-radius: 0;
        transition: all 0.2s ease;
        cursor: pointer;
        border: 1px solid transparent;
    }
    
    .btn-primary {
        background-color: #1e3a8a;
        color: #ffffff;
        border-color: #1e3a8a;
    }
    
    .btn-primary:hover {
        background-color: #1e40af;
        border-color: #1e40af;
    }
    
    .btn-secondary {
        background-color: #f3f4f6;
        color: #374151;
        border-color: #d1d5db;
    }
    
    .btn-secondary:hover {
        background-color: #e5e7eb;
        border-color: #9ca3af;
    }
    
    .form-group {
        margin-bottom: 16px;
    }
    
    .form-label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 6px;
    }
    
    .form-select {
        width: 100%;
        border: 1px solid #d1d5db;
        border-radius: 0;
        padding: 8px 12px;
        font-size: 12px;
        background-color: #ffffff;
        outline: none;
        transition: border-color 0.2s ease;
    }
    
    .form-select:focus {
        border-color: #1e3a8a;
    }
    
    .form-select:disabled {
        background-color: #f9fafb;
        color: #6b7280;
    }
</style>
{% endblock %}

{% block communication_content %}
<div class="chat-container flex">
    <!-- Conversation List -->
    <div class="conversation-list flex-shrink-0">
        <!-- New Conversation Button -->
        <button class="new-conversation-btn" onclick="showNewConversationModal()">
            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            New Conversation
        </button>
        
        <!-- Search -->
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Search conversations..." id="searchConversations">
        </div>
        
        <!-- Conversations -->
        <div class="conversations-list">
            {% for conversation in conversations %}
            <div class="conversation-item {% if conversation.user.id == selected_user_id %}active{% endif %}" 
                 onclick="selectConversation({{ conversation.user.id }}, '{{ conversation.user.get_full_name|default:conversation.user.username }}')">
                <div class="conversation-info">
                    <div class="conversation-avatar">
                        {{ conversation.user.get_full_name|default:conversation.user.username|first|upper }}
                    </div>
                    <div class="conversation-details">
                        <div class="conversation-name">
                            {{ conversation.user.get_full_name|default:conversation.user.username }}
                            <span class="user-type-badge {% if conversation.user.lawyerprofile %}lawyer{% else %}client{% endif %}">
                                {% if conversation.user.lawyerprofile %}Lawyer{% else %}Client{% endif %}
                            </span>
                        </div>
                        <div class="conversation-preview">
                            {{ conversation.latest_message.content|truncatechars:50 }}
                        </div>
                    </div>
                    <div class="conversation-time">
                        {{ conversation.latest_message.created_at|timesince }} ago
                    </div>
                    {% if conversation.unread_count > 0 %}
                    <div class="unread-badge">{{ conversation.unread_count }}</div>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="p-4 text-center text-gray-500">
                <p>No conversations yet</p>
                <p class="text-sm">Start a new conversation to begin chatting</p>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Chat Area -->
    <div class="chat-area flex-1">
        {% if selected_user %}
        <!-- Chat Header -->
        <div class="chat-header">
            <div class="flex items-center gap-3">
                <div class="chat-avatar">
                    {{ selected_user.get_full_name|default:selected_user.username|first|upper }}
                </div>
                <div>
                    <h3 class="font-semibold text-gray-900">
                        {{ selected_user.get_full_name|default:selected_user.username }}
                        <span class="user-type-badge {% if selected_user.lawyerprofile %}lawyer{% else %}client{% endif %} ml-2">
                            {% if selected_user.lawyerprofile %}Lawyer{% else %}Client{% endif %}
                        </span>
                    </h3>
                    <p class="text-sm text-gray-500">
                        {% if selected_user.lawyerprofile %}
                            {{ selected_user.lawyerprofile.specialization|default:"General Practice" }}
                        {% else %}
                            Client
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Chat Messages -->
        <div class="chat-messages" id="chatMessages">
            {% for message in messages %}
            <div class="message-bubble {% if message.sender == request.user %}message-sent{% else %}message-received{% endif %}">
                {% if message.sender != request.user %}
                <div class="message-sender">{{ message.sender.get_full_name|default:message.sender.username }}</div>
                {% endif %}
                <div class="message-content">{{ message.content }}</div>
                <div class="message-time">{{ message.created_at|date:"g:i A" }}</div>
                
                {% if message.attachments.all %}
                {% for attachment in message.attachments.all %}
                <div class="document-message">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 document-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <div>
                            <div class="document-name">{{ attachment.filename }}</div>
                            <div class="document-size">{{ attachment.filesize|filesizeformat }}</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% endif %}
            </div>
            {% empty %}
            <div class="empty-chat">
                <svg class="w-16 h-16 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
                <p class="text-lg font-medium text-gray-500">No messages yet</p>
                <p class="text-sm text-gray-400">Start the conversation by sending a message</p>
            </div>
            {% endfor %}
        </div>
        
        <!-- Chat Input -->
        <div class="chat-input">
            <form class="chat-input-form" id="messageForm" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="recipient_id" value="{{ selected_user.id }}">
                
                <!-- File Attachment -->
                <label for="fileInput" class="attachment-button cursor-pointer">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                    </svg>
                </label>
                <input type="file" id="fileInput" name="attachment" class="hidden" multiple>
                
                <!-- Message Input -->
                <input type="text" class="chat-input-field" name="content" placeholder="Type your message..." id="messageInput" required>
                
                <!-- Send Button -->
                <button type="submit" class="send-button" id="sendButton">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </form>
        </div>
        {% else %}
        <!-- Empty State -->
        <div class="empty-chat">
            <svg class="w-16 h-16 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
            </svg>
            <p class="text-lg font-medium text-gray-500">Select a conversation</p>
            <p class="text-sm text-gray-400">Choose a conversation from the list to start chatting</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- New Conversation Modal -->
<div id="newConversationModal" class="modal-overlay fixed inset-0 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="modal-content max-w-md w-full">
            <div class="modal-header">
                <h3 class="text-lg font-semibold text-gray-900">New Conversation</h3>
                <button onclick="hideNewConversationModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select User Type</label>
                    <select id="userTypeSelect" class="form-select">
                        <option value="">Choose user type...</option>
                        <option value="client">Client</option>
                        <option value="lawyer">Lawyer</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Select User</label>
                    <select id="userSelect" class="form-select" disabled>
                        <option value="">Choose a user...</option>
                    </select>
                </div>
            </div>
            
            <div class="modal-footer">
                <button onclick="hideNewConversationModal()" class="btn btn-secondary">
                    Cancel
                </button>
                <button onclick="startNewConversation()" class="btn btn-primary">
                    Start Conversation
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let selectedUserId = null;
let selectedUserName = '';

function selectConversation(userId, userName) {
    selectedUserId = userId;
    selectedUserName = userName;
    
    // Update active state
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    
    // Load messages for this conversation
    loadMessages(userId);
}

function loadMessages(userId) {
    fetch(`/communication/api/messages/${userId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayMessages(data.messages);
            }
        })
        .catch(error => {
            console.error('Error loading messages:', error);
        });
}

function displayMessages(messages) {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '';
    
    if (messages.length === 0) {
        chatMessages.innerHTML = `
            <div class="empty-chat">
                <svg class="w-16 h-16 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
                <p class="text-lg font-medium text-gray-500">No messages yet</p>
                <p class="text-sm text-gray-400">Start the conversation by sending a message</p>
            </div>
        `;
        return;
    }
    
    messages.forEach(message => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-bubble ${message.sender_id === {{ request.user.id }} ? 'message-sent' : 'message-received'}`;
        
        let content = `
            ${message.sender_id !== {{ request.user.id }} ? `<div class="message-sender">${message.sender_name}</div>` : ''}
            <div class="message-content">${message.content}</div>
            <div class="message-time">${new Date(message.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        `;
        
        messageDiv.innerHTML = content;
        chatMessages.appendChild(messageDiv);
    });
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showNewConversationModal() {
    document.getElementById('newConversationModal').classList.remove('hidden');
    loadUsers();
}

function hideNewConversationModal() {
    document.getElementById('newConversationModal').classList.add('hidden');
}

function loadUsers() {
    const userType = document.getElementById('userTypeSelect').value;
    if (!userType) return;
    
    fetch(`/communication/api/users/${userType}/`)
        .then(response => response.json())
        .then(data => {
            const userSelect = document.getElementById('userSelect');
            userSelect.innerHTML = '<option value="">Choose a user...</option>';
            
            data.users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                userSelect.appendChild(option);
            });
            
            userSelect.disabled = false;
        })
        .catch(error => {
            console.error('Error loading users:', error);
        });
}

function startNewConversation() {
    const userId = document.getElementById('userSelect').value;
    if (!userId) return;
    
    hideNewConversationModal();
    selectConversation(userId, document.getElementById('userSelect').selectedOptions[0].textContent);
}

// Event listeners
document.getElementById('userTypeSelect').addEventListener('change', loadUsers);

document.getElementById('messageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const sendButton = document.getElementById('sendButton');
    const messageInput = document.getElementById('messageInput');
    
    // Disable send button
    sendButton.disabled = true;
    
    fetch('/communication/api/messages/send/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            document.getElementById('fileInput').value = '';
            
            // Reload messages
            if (selectedUserId) {
                loadMessages(selectedUserId);
            }
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
    })
    .finally(() => {
        sendButton.disabled = false;
    });
});

// Search functionality
document.getElementById('searchConversations').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const conversationItems = document.querySelectorAll('.conversation-item');
    
    conversationItems.forEach(item => {
        const name = item.querySelector('.conversation-name').textContent.toLowerCase();
        if (name.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
});

// Auto-scroll to bottom when new messages arrive
const chatMessages = document.getElementById('chatMessages');
if (chatMessages) {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}
</script>
{% endblock %}