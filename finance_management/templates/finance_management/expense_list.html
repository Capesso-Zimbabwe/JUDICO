{% extends 'finance_management/base.html' %}
{% load humanize %}

{% block title %}Expense Report - Finance Management{% endblock %}

{% block header_title %}Expense Report{% endblock %}

{% block finance_content %}
    <div class="bg-white rounded-sm shadow-md flex flex-col overflow-hidden flex-1 max-w-full max-h-full">

        <!-- Header Section -->
        <div class="bg-white px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-lg font-semibold text-gray-900">Expense Report</h1>
                    <p class="text-sm text-gray-600">Main Campus Dormitory</p>
                </div>
                <div class="flex gap-2">
                    <button class="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">
                        <i class="fas fa-edit mr-1"></i> Edit
                    </button>
                    <button class="px-3 py-1 text-xs bg-gray-800 text-white rounded hover:bg-gray-700">
                        <i class="fas fa-download mr-1"></i> Export
                    </button>
                </div>
            </div>
        </div>

        <!-- Month Selection and Quick Select -->
        <div class="bg-white px-6 py-3 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div>
                        <label class="text-sm font-medium text-gray-700 mb-1 block">Select Months</label>
                        <div class="grid grid-cols-4 gap-1">
                            <button class="px-3 py-1 text-xs bg-blue-600 text-white rounded">Jan</button>
                            <button class="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">Feb</button>
                            <button class="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">Mar</button>
                            <button class="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">Apr</button>
                            <button class="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">May</button>
                            <button class="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">Jun</button>
                            <button class="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">Jul</button>
                            <button class="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">Aug</button>
                            <button class="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">Sep</button>
                            <button class="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">Oct</button>
                            <button class="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">Nov</button>
                            <button class="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">Dec</button>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700 mb-1 block">Boarding House</label>
                        <select class="text-sm border border-gray-300 rounded px-3 py-1">
                            <option>Main Campus Dormitory</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div>
                        <label class="text-sm font-medium text-gray-700 mb-1 block">Quick Select</label>
                        <div class="flex gap-1">
                            <button class="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">Q1</button>
                            <button class="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">Q2</button>
                            <button class="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">Q3</button>
                            <button class="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">Q4</button>
                            <button class="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">H1</button>
                            <button class="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">H2</button>
                            <button class="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">Full Year</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Report Table -->
        <div class="p-0 overflow-hidden flex flex-col flex-1 max-w-full max-h-full">
            <div class="compact-table flex-1 max-w-full max-h-full scrollbar-thin overflow-auto relative">
                <table class="w-full" id="expensesTable">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900 border-b border-gray-200">
                                Account
                            </th>
                            <th class="px-3 py-3 text-center text-sm font-semibold text-gray-900 border-b border-gray-200">
                                Jan
                            </th>
                            <th class="px-3 py-3 text-center text-sm font-semibold text-gray-900 border-b border-gray-200">
                                Feb
                            </th>
                            <th class="px-3 py-3 text-center text-sm font-semibold text-gray-900 border-b border-gray-200">
                                Mar
                            </th>
                            <th class="px-3 py-3 text-center text-sm font-semibold text-gray-900 border-b border-gray-200">
                                Apr
                            </th>
                            <th class="px-3 py-3 text-center text-sm font-semibold text-gray-900 border-b border-gray-200">
                                May
                            </th>
                            <th class="px-3 py-3 text-center text-sm font-semibold text-gray-900 border-b border-gray-200">
                                Jun
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white">
                        <!-- EXPENSES Section -->
                        <tr class="bg-gray-100">
                            <td class="px-4 py-2 font-bold text-gray-900 border-b border-gray-200" colspan="7">
                                EXPENSES
                            </td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-gray-900 border-b border-gray-100">Utilities - Electricity</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$8,500</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$8,200</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$7,800</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$7,500</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$8,000</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$8,800</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-gray-900 border-b border-gray-100">Utilities - Water</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$3,200</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$3,100</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$3,000</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$2,900</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$3,100</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$3,300</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-gray-900 border-b border-gray-100">Internet & Cable</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$1,500</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$1,500</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$1,500</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$1,500</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$1,500</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$1,500</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-gray-900 border-b border-gray-100">Maintenance & Repairs</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$2,800</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$3,200</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$2,500</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$3,800</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$2,200</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$2,900</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-gray-900 border-b border-gray-100">Cleaning Supplies</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$800</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$850</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$900</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$750</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$800</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$850</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-gray-900 border-b border-gray-100">Security Services</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$2,000</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$2,000</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$2,000</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$2,000</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$2,000</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$2,000</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-gray-900 border-b border-gray-100">Insurance</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$1,200</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$1,200</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$1,200</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$1,200</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$1,200</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$1,200</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-gray-900 border-b border-gray-100">Property Tax</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$1,500</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$0</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$0</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$0</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$0</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$1,500</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-gray-900 border-b border-gray-100">Staff Salaries</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$12,000</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$12,000</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$12,500</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$12,500</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$13,000</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$13,000</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-gray-900 border-b border-gray-100">Food & Kitchen Supplies</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$8,500</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$8,800</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$9,200</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$9,500</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$9,800</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$10,200</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-gray-900 border-b border-gray-100">Office Supplies</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$500</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$600</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$450</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$700</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$550</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$650</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-gray-900 border-b border-gray-100">Professional Fees</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$2,500</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$2,500</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$2,500</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$2,500</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$2,500</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-100">$2,500</td>
                        </tr>
                        <tr class="bg-gray-50 font-semibold">
                            <td class="px-4 py-2 text-gray-900 border-b border-gray-200">Total Expenses</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-200">$42,500</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-200">$42,750</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-200">$40,050</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-200">$43,650</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-200">$42,650</td>
                            <td class="px-3 py-2 text-right text-gray-900 border-b border-gray-200">$45,200</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Pagination -->
        {% include 'components/paginator.html' %}
    </div>

    <!-- Modals -->
    <div id="new-expense-modal-container">
        {% include "finance_management/new_expense_modal.html" with modal_id="new-expense-modal" %}
    </div>
    {% include "finance_management/modals/expense_details_modal.html" with modal_id="details-expense-modal" %}
    <div id="update-expense-modal-container">
        {% include "finance_management/modals/update_expense_modal.html" with modal_id="update-expense-modal" %}
    </div>

{% endblock %}

{% block extra_js %}
    <script>
        // Global modal functions (must be outside DOMContentLoaded for onclick access)
        function viewExpenseDetails(expenseId) {
            // Fetch expense details from API
            fetch(`/finance/api/expenses/${expenseId}/`)
                .then(response => response.json())
                .then(data => {
                    // Populate details modal with fetched data
                    document.getElementById('detailExpenseTitle').textContent = data.title;
                    document.getElementById('detailExpenseDescription').textContent = data.description || 'No description';
                    document.getElementById('detailExpenseAmount').textContent = '$' + parseFloat(data.amount).toFixed(2);
                    document.getElementById('detailExpenseCategory').textContent = data.category_display;
                    document.getElementById('detailExpenseDate').textContent = data.expense_date;
                    document.getElementById('detailExpenseCreatedBy').textContent = data.created_by;
                    document.getElementById('detailExpenseStatus').textContent = data.approved_by ? 'Approved' : 'Pending';
                    
                    // Handle receipt display
                    const receiptContainer = document.getElementById('detailExpenseReceipt');
                    if (data.receipt_url) {
                        receiptContainer.innerHTML = `<a href="${data.receipt_url}" target="_blank" class="inline-flex items-center text-blue-600 hover:text-blue-800"><svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"/></svg>View Receipt</a>`;
                    } else {
                        receiptContainer.innerHTML = '<span class="text-gray-500">No receipt uploaded</span>';
                    }
                    
                    // Set status badge color
                    const statusBadge = document.getElementById('detailExpenseStatus');
                    if (data.approved_by) {
                        statusBadge.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                    } else {
                        statusBadge.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
                    }
                    
                    // Store expense ID for edit button
                    const editButton = document.getElementById('editExpenseFromModal');
                    if (editButton) {
                        editButton.onclick = function() {
                            editExpense(expenseId);
                        };
                    }
                    
                    // Show the modal after populating data
                    if (window.detailsExpenseModal) {
                        window.detailsExpenseModal.show();
                    }
                })
                .catch(error => {
                    console.error('Error fetching expense details:', error);
                });
        }

        function editExpense(expenseId) {
             // Close details modal
             if (window.detailsExpenseModal) {
                 window.detailsExpenseModal.hide();
             }
             
             // Fetch expense data
             fetch(`/finance/api/expenses/${expenseId}/`)
                 .then(response => response.json())
                 .then(data => {
                     // Populate form fields
                     document.getElementById('updateExpenseTitle').value = data.title || '';
                     document.getElementById('updateExpenseAmount').value = data.amount || '0.00';
                     document.getElementById('updateExpenseCategory').value = data.category || '';
                     document.getElementById('updateExpenseDate').value = data.expense_date || '';
                     document.getElementById('updateExpenseDescription').value = data.description || '';
                     
                     // Update form action URL
                     const form = document.getElementById('updateExpenseForm');
                     if (form) {
                         form.setAttribute('hx-post', `/finance/expenses/${expenseId}/edit/`);
                     }
                     
                     // Show the modal
                     if (window.updateExpenseModal) {
                         window.updateExpenseModal.show();
                     }
                 })
                 .catch(error => {
                     console.error('Error fetching expense details:', error);
                     alert('Error loading expense data. Please try again.');
                 });
         }

        function approveExpense(expenseId) {
            if (confirm('Are you sure you want to approve this expense?')) {
                fetch(`/finance/expenses/${expenseId}/approve/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        // Close modal and reload page
                        if (window.detailsExpenseModal) {
                            window.detailsExpenseModal.hide();
                        }
                        location.reload();
                    } else {
                        console.error('Error approving expense');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
        }

        function openNewExpenseModal() {
             // Show the modal using Flowbite
             if (window.newExpenseModal) {
                 window.newExpenseModal.show();
             }
         }

        // Initialize all functionality when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Search functionality
            const searchInput = document.getElementById('id_search');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    filterTable();
                });
            }

            // Filter functionality
            const categoryFilter = document.getElementById('categoryFilter');
            const statusFilter = document.getElementById('statusFilter');
            
            if (categoryFilter) {
                categoryFilter.addEventListener('change', filterTable);
            }
            if (statusFilter) {
                statusFilter.addEventListener('change', filterTable);
            }

            function filterTable() {
                const searchTerm = document.getElementById('id_search').value.toLowerCase();
                const categoryFilter = document.getElementById('categoryFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                const rows = document.querySelectorAll('#expensesTableBody tr');

                rows.forEach(row => {
                    const title = row.getAttribute('data-expense-title') || '';
                    const description = row.getAttribute('data-expense-description') || '';
                    const category = row.getAttribute('data-expense-category') || '';
                    const status = row.getAttribute('data-expense-status') || '';

                    const matchesSearch = title.includes(searchTerm) || description.includes(searchTerm);
                    const matchesCategory = !categoryFilter || category === categoryFilter;
                    const matchesStatus = !statusFilter || status === statusFilter;

                    if (matchesSearch && matchesCategory && matchesStatus) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            // Initialize Flowbite modals (modalOptions is defined in base template)
            if (typeof Modal !== 'undefined' && typeof modalOptions !== 'undefined') {
                const newExpenseModalElement = document.getElementById('new-expense-modal');
                if (newExpenseModalElement) {
                    window.newExpenseModal = new Modal(newExpenseModalElement, modalOptions, {
                        id: 'new-expense-modal',
                        override: true
                    });
                }
                
                const detailsExpenseModalElement = document.getElementById('details-expense-modal');
                if (detailsExpenseModalElement) {
                    window.detailsExpenseModal = new Modal(detailsExpenseModalElement, modalOptions, {
                        id: 'details-expense-modal',
                        override: true
                    });
                }
                
                // Initialize Update Expense Modal
                const updateExpenseModalElement = document.getElementById('update-expense-modal');
                if (updateExpenseModalElement) {
                    window.updateExpenseModal = new Modal(updateExpenseModalElement, modalOptions, {
                        id: 'update-expense-modal',
                        override: true
                    });
                }
            }
        });

        // Handle HTMX events for modal management
        document.addEventListener('htmx:beforeSwap', function(event) {
            // Check if this is a successful form submission (status 200) and targets a modal container
            if (event.detail.xhr.status === 200) {
                if (event.detail.target.id === 'new-expense-modal-container') {
                    // Close the new expense modal
                    if (window.newExpenseModal) {
                        window.newExpenseModal.hide();
                    }
                    // Refresh the page to show the new expense in the table
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else if (event.detail.target.id === 'update-expense-modal-container') {
                    // Close the update expense modal
                    if (window.updateExpenseModal) {
                        window.updateExpenseModal.hide();
                    }
                    // Refresh the page to show the updated expense in the table
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                }
            }
        });
    </script>
{% endblock %}