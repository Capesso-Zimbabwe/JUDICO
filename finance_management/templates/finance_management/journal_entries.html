{% extends 'finance_management/base.html' %}

{% block title %}Journal Entries - Finance Management{% endblock %}

{% block header_title %}Finance Management - Journal Entries{% endblock %}

{% block finance_content %}
    <div class="bg-white rounded-sm shadow-md flex flex-col overflow-hidden flex-1 max-w-full max-h-full main-content">

        <!-- Filters Section -->
        <div class="bg-white px-4 py-3 flex items-center justify-between">
            <form action="" class="flex-1 max-w-sm" id="search-form">
                {% include "components/field.html" with hide_label=True field=search_form.search %}
            </form>
            
            <div class="flex gap-2 items-center">
                <select name="status" form="search-form" onchange="document.getElementById('search-form').submit()" class="text-xs border border-gray-300 rounded px-2 py-1">
                    <option value="">All Status</option>
                    <option value="DRAFT" {% if request.GET.status == 'DRAFT' %}selected{% endif %}>Draft</option>
                    <option value="POSTED" {% if request.GET.status == 'POSTED' %}selected{% endif %}>Posted</option>
                    <option value="REVERSED" {% if request.GET.status == 'REVERSED' %}selected{% endif %}>Reversed</option>
                </select>
                
                <a hx-get="{% url 'finance_management:journal_entry_create' %}"
                   hx-target="#new-modal-container"
                   hx-indicator="#new-modal-overlay"
                   hx-trigger="click"
                   data-modal-target="new-modal" data-modal-toggle="new-modal"
                   href="{% url 'finance_management:journal_entry_create' %}" class="p-2 flex gap-1">
                    <svg class="w-4 h-4 text-gray-800" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24"
                         height="24" fill="none" viewBox="0 0 24 24">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M5 12h14m-7 7V5"></path>
                    </svg>
                    <span class="font-bold">Add Journal Entry</span>
                </a>
            </div>
        </div>

        <div class="p-0 overflow-hidden flex flex-col flex-1 max-w-full max-h-full">
            <div class="compact-table flex-1 max-w-full max-h-full scrollbar-thin overflow-auto relative">
                <table class="w-full divide-y divide-gray-200" id="journalEntriesTable">
                    <thead class="bg-gray-100 whitespace-nowrap text-xs sticky top-0 z-10">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-b border-gray-200">
                                Entry Number
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-b border-gray-200">
                                Date
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-b border-gray-200">
                                Description
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-b border-gray-200">
                                Reference
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-b border-gray-200">
                                Total Amount
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-b border-gray-200">
                                Status
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-b border-gray-200">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="journalEntriesTableBody">
                    {% for entry in journal_entries %}
                        <tr class="hover:bg-gray-50 transition-colors duration-200" 
                            data-entry-id="{{ entry.id }}" 
                            data-entry-number="{{ entry.entry_number }}" 
                            data-entry-status="{{ entry.status }}">
                            <td class="px-3 py-1 whitespace-nowrap text-xs font-medium text-gray-900 font-mono">JE-{{ entry.entry_number }}</td>
                            <td class="px-3 py-1 whitespace-nowrap text-xs font-medium text-gray-900">{{ entry.date|date:"M d, Y" }}</td>
                            <td class="px-3 py-1 whitespace-nowrap">
                                <button type="button"
                                        class="text-blue-600 flex items-center hover:text-blue-800 transition-colors duration-200 cursor-pointer"
                                        onclick="viewJournalEntry('{{ entry.id }}')">
                                    <div class="flex-shrink-0 h-8 w-8">
                                        <div class="h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center">
                                            <span class="text-indigo-600 font-medium text-xs">{{ entry.description|first|upper }}</span>
                                        </div>
                                    </div>
                                    <div class="ml-2">
                                        <div class="text-xs font-medium text-gray-900">
                                            <span>{{ entry.description|truncatechars:30 }}</span>
                                        </div>
                                    </div>
                                </button>
                            </td>
                            <td class="px-3 py-1 whitespace-nowrap text-xs font-medium text-gray-900">{{ entry.reference|default:"-" }}</td>
                            <td class="px-3 py-1 whitespace-nowrap text-xs font-medium text-gray-900 font-mono">${{ entry.total_debit|floatformat:2 }}</td>
                            <td class="px-3 py-1 whitespace-nowrap">
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                                    {% if entry.status == 'POSTED' %}bg-green-100 text-green-800
                                    {% elif entry.status == 'DRAFT' %}bg-yellow-100 text-yellow-800
                                    {% elif entry.status == 'REVERSED' %}bg-red-100 text-red-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ entry.get_status_display }}
                                </span>
                            </td>
                            <td class="px-3 py-1 whitespace-nowrap text-xs font-medium">
                                <div class="flex space-x-2">
                                    <!-- View Details -->
                                    <button type="button"
                                            class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-green-100 text-green-600 hover:bg-green-200 hover:text-green-700 transition-all duration-200 shadow-sm hover:shadow-md"
                                            title="View Journal Entry"
                                            data-modal-target="details-modal" 
                                            data-modal-toggle="details-modal"
                                            onclick="viewJournalEntryDetails('{{ entry.id }}')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"></path>
                                        </svg>
                                    </button>
                                    <!-- Edit -->
                                    <button type="button"
                                            class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 hover:text-blue-700 transition-all duration-200 shadow-sm hover:shadow-md"
                                            title="Edit Journal Entry"
                                            data-modal-target="update-modal" 
                                            data-modal-toggle="update-modal"
                                            onclick="editJournalEntry('{{ entry.id }}')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path>
                                        </svg>
                                    </button>
                                    <!-- Lines -->
                                    <button type="button"
                                            class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 hover:text-purple-700 transition-all duration-200 shadow-sm hover:shadow-md"
                                            title="View Entry Lines"
                                            data-modal-target="lines-modal" 
                                            data-modal-toggle="lines-modal"
                                            onclick="viewJournalEntryLines('{{ entry.id }}')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"></path>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="7" class="px-6 py-12 text-center">
                                <div class="flex flex-col items-center justify-center">
                                    <i class="fas fa-book text-4xl text-gray-400 mb-4"></i>
                                    <h3 class="text-xs font-medium text-gray-900 mb-1">No journal entries found</h3>
                                    <p class="text-xs text-gray-500">Get started by creating your first journal entry.</p>
                                    <a hx-get="{% url 'finance_management:journal_entry_create' %}"
                                       hx-target="#new-modal-container"
                                       hx-indicator="#new-modal-overlay"
                                       hx-trigger="click"
                                       data-modal-target="new-modal" data-modal-toggle="new-modal"
                                       href="{% url 'finance_management:journal_entry_create' %}"
                                       class="mt-4 inline-flex items-center text-xs bg-blue-900 text-white py-1.5 px-4 rounded-sm font-medium hover:bg-blue-700 transition-all duration-200 transform disabled:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                        Add Your First Journal Entry
                                    </a>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    {% include "components/paginator.html" %}

    <!-- Modals -->
    {% include "finance_management/modals/new_journal_entry_modal.html" with modal_id="new-modal" %}
    {% include "finance_management/modals/journal_entry_details_modal.html" with modal_id="details-modal" %}
    {% include "finance_management/modals/update_journal_entry_modal.html" with modal_id="update-modal" %}
    {% include "finance_management/modals/journal_entry_lines_modal.html" with modal_id="lines-modal" %}

    <!-- Modal containers -->
    <div id="new-modal-container"></div>
    <div id="new-modal-overlay" class="htmx-indicator fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
    </div>

{% endblock %}

{% block extra_js %}
    <script>
        // Import Flowbite Modal class
        const { Modal, Instances: FlowbiteInstances } = window.Flowbite || { Modal: class {}, Instances: { getInstance: () => null } };
        // Prevent body scroll issues when modals are opened/closed
        function preventBodyScrollIssues() {
            // Remove any lingering modal-related classes from body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            // Reset any transform or positioning issues on main content
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.style.transform = '';
                mainContent.style.position = '';
                mainContent.style.marginLeft = '';
                mainContent.style.marginRight = '';
            }
        }

        // JavaScript functions for journal entry operations
        function viewJournalEntryDetails(journalEntryId) {
            // Fetch journal entry details via API
            fetch(`/finance/journal-entries/${journalEntryId}/api/`)
                .then(response => response.json())
                .then(data => {
                    // Populate modal with data
                    document.getElementById('details-entry-number').textContent = data.entry_number;
                    document.getElementById('details-date').textContent = data.date;
                    document.getElementById('details-description').textContent = data.description;
                    document.getElementById('details-reference').textContent = data.reference || '-';
                    document.getElementById('details-status').textContent = data.status;
                    document.getElementById('details-total-debit').textContent = '$' + parseFloat(data.total_debit || 0).toFixed(2);
                    document.getElementById('details-total-credit').textContent = '$' + parseFloat(data.total_credit || 0).toFixed(2);
                    document.getElementById('details-balanced').textContent = data.is_balanced ? 'Yes' : 'No';
                    document.getElementById('details-created-by').textContent = data.created_by;
                    document.getElementById('details-created-at').textContent = new Date(data.created_at).toLocaleString();
                    
                    // Show modal using Flowbite
                    if (window.detailsJournalModal) {
                        window.detailsJournalModal.show();
                    }
                })
                .catch(error => {
                    console.error('Error fetching journal entry details:', error);
                    alert('Error loading journal entry details');
                });
         
         // Fix for HTMX modal close
         document.body.addEventListener('htmx:afterRequest', function(evt) {
             // Reset layout after any HTMX request that might affect modals
             setTimeout(preventBodyScrollIssues, 100);
         });
        }

        function editJournalEntry(journalEntryId) {
            // Fetch journal entry details for editing
            fetch(`/finance/journal-entries/${journalEntryId}/api/`)
                .then(response => response.json())
                .then(data => {
                    // Populate update form with data
                    document.getElementById('update-entry-number').value = data.entry_number;
                    document.getElementById('update-date').value = data.date;
                    document.getElementById('update-description').value = data.description;
                    document.getElementById('update-reference').value = data.reference || '';
                    document.getElementById('update-status').value = data.status;
                    
                    // Populate journal entry lines
                    const tbody = document.getElementById('update-journal-lines-tbody');
                    tbody.innerHTML = '';
                    
                    data.lines.forEach((line, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-4 py-3">
                                <select name="lines-${index}-account" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                                    <option value="${line.account_id}">${line.account_code} - ${line.account_name}</option>
                                </select>
                            </td>
                            <td class="px-4 py-3">
                                <input type="text" name="lines-${index}-description" value="${line.description || ''}" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            </td>
                            <td class="px-4 py-3">
                                <input type="number" name="lines-${index}-debit_amount" value="${line.debit_amount || ''}" step="0.01" min="0" class="update-debit-input bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            </td>
                            <td class="px-4 py-3">
                                <input type="number" name="lines-${index}-credit_amount" value="${line.credit_amount || ''}" step="0.01" min="0" class="update-credit-input bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            </td>
                            <td class="px-4 py-3">
                                <button type="button" class="update-remove-line-btn text-red-600 hover:text-red-800 text-sm font-medium">
                                    Remove
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    updateUpdateTotals();
                    
                    // Show modal using Flowbite
                    if (window.updateJournalModal) {
                        window.updateJournalModal.show();
                    }
                })
                .catch(error => {
                    console.error('Error fetching journal entry for editing:', error);
                    alert('Error loading journal entry for editing');
                });
        }

        function viewJournalEntryLines(journalEntryId) {
            // Fetch journal entry lines via API
            fetch(`/finance/journal-entries/${journalEntryId}/api/`)
                .then(response => response.json())
                .then(data => {
                    // Populate header info
                    document.getElementById('lines-entry-number').textContent = data.entry_number;
                    document.getElementById('lines-date').textContent = data.date;
                    document.getElementById('lines-status').textContent = data.status;
                    document.getElementById('lines-description').textContent = data.description;
                    
                    // Populate lines table
                    const tbody = document.getElementById('journal-lines-table-body');
                    tbody.innerHTML = '';
                    
                    let totalDebit = 0;
                    let totalCredit = 0;
                    
                    data.lines.forEach(line => {
                        const row = document.createElement('tr');
                        row.className = 'bg-white border-b hover:bg-gray-50';
                        row.innerHTML = `
                            <td class="px-6 py-4 font-mono text-sm">${line.account_code}</td>
                            <td class="px-6 py-4">${line.account_name}</td>
                            <td class="px-6 py-4">${line.description || '-'}</td>
                            <td class="px-6 py-4 text-right font-mono">$${parseFloat(line.debit_amount || 0).toFixed(2)}</td>
                            <td class="px-6 py-4 text-right font-mono">$${parseFloat(line.credit_amount || 0).toFixed(2)}</td>
                        `;
                        tbody.appendChild(row);
                        
                        totalDebit += parseFloat(line.debit_amount || 0);
                        totalCredit += parseFloat(line.credit_amount || 0);
                    });
                    
                    // Update totals
                    document.getElementById('lines-total-debit').textContent = '$' + totalDebit.toFixed(2);
                    document.getElementById('lines-total-credit').textContent = '$' + totalCredit.toFixed(2);
                    
                    const difference = totalDebit - totalCredit;
                    const balanceStatus = document.getElementById('lines-balance-status');
                    const differenceElement = document.getElementById('lines-difference');
                    
                    if (difference === 0) {
                        balanceStatus.textContent = 'Balanced';
                        balanceStatus.className = 'text-sm font-bold text-green-600';
                        differenceElement.textContent = '$0.00';
                        differenceElement.className = 'text-sm font-mono text-green-600';
                    } else {
                        balanceStatus.textContent = 'Unbalanced';
                        balanceStatus.className = 'text-sm font-bold text-red-600';
                        differenceElement.textContent = '$' + Math.abs(difference).toFixed(2);
                        differenceElement.className = 'text-sm font-mono text-red-600';
                    }
                    
                    // Show modal using Flowbite
                    if (window.linesJournalModal) {
                        window.linesJournalModal.show();
                    }
                })
                .catch(error => {
                    console.error('Error fetching journal entry lines:', error);
                    alert('Error loading journal entry lines');
                });
        }

        function viewJournalEntry(journalEntryId) {
            // Redirect to journal entry detail page
            window.location.href = `/finance/journal-entries/${journalEntryId}/`;
        }

        // Update modal totals calculation functions
        function updateUpdateTotals() {
            let totalDebit = 0;
            let totalCredit = 0;
            
            document.querySelectorAll('.update-debit-input').forEach(input => {
                totalDebit += parseFloat(input.value) || 0;
            });
            
            document.querySelectorAll('.update-credit-input').forEach(input => {
                totalCredit += parseFloat(input.value) || 0;
            });
            
            const difference = totalDebit - totalCredit;
            
            document.getElementById('update-total-debit').textContent = '$' + totalDebit.toFixed(2);
            document.getElementById('update-total-credit').textContent = '$' + totalCredit.toFixed(2);
            
            const diffElement = document.getElementById('update-difference');
            diffElement.textContent = '$' + Math.abs(difference).toFixed(2);
            
            if (difference === 0) {
                diffElement.className = 'text-sm font-mono text-green-600';
            } else {
                diffElement.className = 'text-sm font-mono text-red-600';
            }
        }

        // Event listeners for update modal
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('update-debit-input') || e.target.classList.contains('update-credit-input')) {
                updateUpdateTotals();
            }
        });

        // Initialize Flowbite modals when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded event fired');
            
            // Wait for Flowbite to be fully loaded
            setTimeout(function() {
                console.log('Available globals:', {
                    Modal: typeof Modal,
                    Flowbite: typeof window.Flowbite,
                    FlowbiteKeys: window.Flowbite ? Object.keys(window.Flowbite) : 'N/A'
                });
                
                // Use simple modal show/hide functions instead of Flowbite instances
                window.showModal = function(modalId) {
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.classList.remove('hidden');
                        modal.setAttribute('aria-hidden', 'false');
                        document.body.style.overflow = 'hidden';
                        console.log('Showing modal:', modalId);
                    }
                };
                
                window.hideModal = function(modalId) {
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.classList.add('hidden');
                        modal.setAttribute('aria-hidden', 'true');
                        document.body.style.overflow = '';
                        console.log('Hiding modal:', modalId);
                    }
                };
                
                // Create modal objects with show/hide methods
                window.newJournalModal = {
                    show: () => window.showModal('new-modal'),
                    hide: () => window.hideModal('new-modal')
                };
                
                window.detailsJournalModal = {
                    show: () => window.showModal('details-modal'),
                    hide: () => window.hideModal('details-modal')
                };
                
                window.updateJournalModal = {
                    show: () => window.showModal('update-modal'),
                    hide: () => window.hideModal('update-modal')
                };
                
                window.linesJournalModal = {
                    show: () => window.showModal('lines-modal'),
                    hide: () => window.hideModal('lines-modal')
                };
                
                console.log('Custom modal handlers initialized');
                
                // Add click handlers for modal close buttons
                document.querySelectorAll('[data-modal-hide]').forEach(button => {
                    button.addEventListener('click', function() {
                        const modalId = this.getAttribute('data-modal-hide');
                        window.hideModal(modalId);
                    });
                });
                
            }, 200);
            
            // Handle HTMX modal loading
            document.addEventListener('htmx:afterSwap', function(e) {
                // If the swap target is a modal container, show the modal
                if (e.target.id === 'new-modal-container') {
                    if (window.newJournalModal) {
                        window.newJournalModal.show();
                    }
                }
            });
        });
    </script>
    
    <style>
        /* Additional CSS to prevent modal-related layout issues */
        .modal-open {
            overflow: hidden !important;
        }
        
        /* Ensure main content area maintains proper layout */
        .main-content {
            position: relative;
            z-index: 1;
            transition: none !important;
        }
        
        /* Fix for any transform issues */
        body:not(.modal-open) {
            transform: none !important;
        }
        
        /* Ensure modals don't affect main content positioning */
        .fixed.inset-0.z-50 {
            position: fixed !important;
        }
    </style>
{% endblock %}