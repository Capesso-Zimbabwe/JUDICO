{% extends 'transaction_support/base.html' %}

{% block transaction_content %}

    <!-- Transaction Management Table -->
    <div class="bg-white rounded-sm shadow-md flex flex-col overflow-hidden flex-1 max-w-full max-h-full">
        <div class="bg-white px-4 py-3 flex items-center justify-between">
            {#            <h6 class="text-black font-bold text-xs m-0">All Transactions</h6>#}
            <form action="" class="flex-1 max-w-sm" id="search-form">
                {% include "components/field.html" with hide_label=True field=filter_form.search %}
            </form>
            <a hx-get="{% url 'transaction_support:transaction_create_modal' %}"
               hx-target="#new-modal-container"
               hx-indicator="#new-modal-overlay"
               hx-trigger="click"
               data-modal-target="new-modal" data-modal-toggle="new-modal"
               href="{% url 'transaction_support:transaction_create_modal' %}" class="p-2 flex gap-1">
                <svg class="w-4 h-4 text-gray-800" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24"
                     height="24" fill="none" viewBox="0 0 24 24">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M5 12h14m-7 7V5"></path>
                </svg>
                <span class="font-bold">Add New Transaction</span>
            </a>
        </div>
    <div class="p-0 overflow-hidden flex flex-col flex-1 max-w-full max-h-full">
        <div class="compact-table flex-1 max-w-full max-h-full scrollbar-thin overflow-auto relative">
            <table class="w-full divide-y divide-gray-200" id="transactionsTable">
                <thead class="bg-gray-100 whitespace-nowrap text-xs sticky top-0 z-10">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-b border-gray-200">
                            Transaction Title
                        </th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-b border-gray-200">
                            Transaction Number
                        </th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-b border-gray-200">
                            Type
                        </th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-b border-gray-200">
                            Value
                        </th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-b border-gray-200">
                            Lead Lawyer
                        </th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-b border-gray-200">
                            Status
                        </th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-b border-gray-200">
                            Tasks
                        </th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-b border-gray-200">
                            Actions
                        </th>
                    </tr>
                    </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                {% for transaction in transactions %}
                    <tr class="hover:bg-gray-50 transition-colors duration-200">
                        <td class="px-3 py-1 whitespace-nowrap">
                                                            <button type="button"
                                        class="text-blue-600 flex items-center hover:text-blue-800 transition-colors duration-200 cursor-pointer"
                                        hx-target="#details-modal-container"
                                        hx-trigger="click"
                                        hx-get="{% url 'transaction_support:transaction_details_modal' transaction.id %}"
                                        hx-indicator="#details-modal-overlay"
                                        hx-swap="innerHTML"
                                        hx-on::after-request="setTimeout(showDetailsModal, 100)"
                                >
                                <div class="flex-shrink-0 h-8 w-8">
                                    <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center">
                                        <span class="text-blue-600 font-medium text-xs">{{ transaction.title|first|upper }}</span>
                                    </div>
                                </div>
                                <div class="ml-2">
                                    <div class="text-xs font-medium text-gray-900">
                                        <span>{{ transaction.title|truncatechars:20 }}</span>
                                    </div>
                                </div>
                            </button>
                        </td>
                        <td class="px-3 py-1 whitespace-nowrap text-xs font-medium text-gray-900 font-mono">{{ transaction.id|stringformat:"04d" }}</td>
                        <td class="px-3 py-1 whitespace-nowrap text-xs text-gray-500">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                                {% if transaction.transaction_type == 'merger_acquisition' %}bg-blue-100 text-blue-800
                                {% elif transaction.transaction_type == 'financing' %}bg-green-100 text-green-800
                                {% elif transaction.transaction_type == 'restructuring' %}bg-yellow-100 text-yellow-800
                                {% elif transaction.transaction_type == 'ipo' %}bg-purple-100 text-purple-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ transaction.get_transaction_type_display }}
                            </span>
                        </td>
                        <td class="px-3 py-1 whitespace-nowrap text-xs text-gray-900">
                            {% if transaction.transaction_value %}
                                ${{ transaction.transaction_value|floatformat:0 }}
                            {% else %}
                                <span class="text-gray-400">Not specified</span>
                            {% endif %}
                        </td>
                        <td class="px-3 py-1 whitespace-nowrap text-xs text-gray-900">
                            {% if transaction.lead_lawyer %}
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-6 w-6">
                                        <div class="h-6 w-6 rounded-full bg-green-100 flex items-center justify-center">
                                            <span class="text-green-600 font-medium text-xs">{{ transaction.lead_lawyer.get_full_name|first|upper }}</span>
                                        </div>
                                    </div>
                                    <div class="ml-1">
                                        <span class="text-xs font-medium text-gray-900">{{ transaction.lead_lawyer.get_full_name|truncatechars:15 }}</span>
                                    </div>
                                </div>
                            {% else %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                    Unassigned
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-3 py-1 whitespace-nowrap">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium {% if transaction.status == 'active' %}bg-green-100 text-green-800{% elif transaction.status == 'completed' %}bg-blue-100 text-blue-800{% elif transaction.status == 'cancelled' %}bg-red-100 text-red-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                {% if transaction.status == 'active' %}
                                    Active
                                {% elif transaction.status == 'completed' %}
                                    Completed
                                {% elif transaction.status == 'cancelled' %}
                                    Cancelled
                                {% else %}
                                    Draft
                                {% endif %}
                            </span>
                        </td>
                        <td class="px-3 py-1 whitespace-nowrap text-xs text-gray-900">
                            {% with transaction_tasks=transaction.transactiontask_set.all %}
                                {% if transaction_tasks %}
                                    <div class="relative">
                                        <button onclick="openTasksModal('{{ transaction.id }}', '{{ transaction.title|escapejs }}', {{ transaction_tasks|length }}); window.tasksModal.show();" class="inline-flex items-center px-3 py-1.5 bg-gray-100 text-gray-700 text-xs font-medium rounded-lg hover:bg-gray-200 hover:text-gray-800 transition-all duration-200 shadow-sm hover:shadow-md border border-gray-300">
                                            <svg class="w-3 h-3 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                            </svg>
                                            {{ transaction_tasks.count }} task{{ transaction_tasks.count|pluralize }}
                                        </button>
                                    </div>
                                {% else %}
                                    <span class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-600 text-xs font-medium rounded-full">
                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                        </svg>
                                        No tasks
                                    </span>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td class="px-3 py-1 whitespace-nowrap text-xs font-medium">
                            <div class="flex space-x-2">
                                <button type="button"
                                        hx-target="#details-modal-container"
                                        hx-trigger="click"
                                        hx-get="{% url 'transaction_support:transaction_details_modal' transaction.id %}"
                                        hx-indicator="#details-modal-overlay"
                                        hx-swap="innerHTML"
                                        hx-on::after-request="setTimeout(showDetailsModal, 100)"
                                        class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-green-100 text-green-600 hover:bg-green-200 hover:text-green-700 transition-all duration-200 shadow-sm hover:shadow-md"
                                        title="View Transaction"

                                >
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"
                                         xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"></path>
                                    </svg>
                                </button>
                                <button
                                        hx-get="{% url 'transaction_support:transaction_edit_modal' transaction.id %}"
                                        hx-indicator="#edit-modal-overlay"
                                        hx-target="#edit-modal-form-container"
                                        hx-trigger="click"
                                        hx-swap="innerHTML"
                                        type="button"
                                        onclick="window.editModal.show()"
                                        class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 hover:text-blue-700 transition-all duration-200 shadow-sm hover:shadow-md"
                                        title="Edit Transaction">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"
                                         xmlns="http://www.w3.org/2000/svg">
                                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path>
                                    </svg>
                                </button>
                            </div>
                        </td>
                </tr>
                    {% empty %}
                        <tr>
                            <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                                <div class="flex flex-col items-center">
                                    <i class="fas fa-handshake text-4xl text-gray-300 mb-4"></i>
                                    <p class="text-xs font-medium">No transactions found</p>
                                    <p class="text-xs">Get started by adding your first transaction.</p>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% include 'components/paginator.html' %}

    </div>

    <!-- Include Paginator Component -->

    <!-- Flowbite Transaction Details Modal -->
    {% include "transaction_support/new-modal.html" with modal_id="new-modal" %}
    {% include "transaction_support/document-modal.html" with modal_id="document-modal" %}

    {% include "transaction_support/tasks-modal.html" with modal_id="tasks-modal" %}
    {% include "transaction_support/task_new_modal.html" with modal_id="task-new-modal" %}
    
    <!-- Flowbite Transaction Edit Modal -->
    {% include "transaction_support/edit-modal.html" with modal_id="edit-modal" %}
    
    <!-- Transaction Details Modal Container for HTMX -->
    <div id="details-modal-container"></div>
    
    <!-- Transaction Edit Modal Container for HTMX -->
    <div id="edit-modal-container"></div>
    
    <!-- Loading Overlay for Details Modal -->
    <div id="details-modal-overlay" class="htmx-indicator fixed inset-0 bg-gray-50/60 flex items-center justify-center shadow-xl backdrop-blur-sm z-50">
        <div class="bg-white rounded-md p-12 shadow-xl max-w-sm mx-4">
            <div class="flex items-center space-x-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <div class="text-gray-900">
                    <div class="font-medium">Loading...</div>
                    <div class="text-sm text-gray-500">Please wait</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay for Edit Modal -->
    <div id="edit-modal-overlay" class="htmx-indicator fixed inset-0 bg-gray-50/60 flex items-center justify-center shadow-xl backdrop-blur-sm z-50">
        <div class="bg-white rounded-md p-12 shadow-xl max-w-sm mx-4">
            <div class="flex items-center space-x-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <div class="text-gray-900">
                    <div class="font-medium">Loading...</div>
                    <div class="text-sm text-gray-500">Please wait</div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
    <script>
        // Initialize details modal after HTMX loads content
        window.detailsModal = null;
        
        // Function to initialize and show details modal
        function showDetailsModal() {
            // Check if modal content exists
            const container = document.getElementById('details-modal-container');
            if (!container || container.children.length === 0) {
                console.log('No modal content to show');
                return;
            }
            
            // Get the modal element from the container
            const detailsModalElement = container.querySelector('[id*="details-modal"]');
            if (!detailsModalElement) {
                console.log('Modal element not found in container');
                return;
            }
            
            // Always reinitialize modal for fresh state
            if (window.detailsModal) {
                window.detailsModal.hide();
                window.detailsModal = null;
            }
            
            // Initialize new modal instance
            window.detailsModal = new Modal(detailsModalElement, modalOptions, {
                id: 'details-modal',
                override: true
            });
            
            // Show the modal
            window.detailsModal.show();
        }
        
        // Function to close details modal
        function closeDetailsModal() {
            if (window.detailsModal) {
                window.detailsModal.hide();
            }
        }
        
        // Function to reset modal state
        function resetModalState() {
            // Clear the modal container
            const container = document.getElementById('details-modal-container');
            if (container) {
                container.innerHTML = '';
            }
            // Don't reset modal instance here - let showDetailsModal handle it
        }
        
        // Initialize edit modal after HTMX loads content
        window.editModal = null;
        
        // Function to initialize and show edit modal
        function showEditModal() {
            console.log('showEditModal called');
            
            // Check if modal content exists
            const container = document.getElementById('edit-modal-container');
            console.log('Container:', container);
            if (!container || container.children.length === 0) {
                console.log('No edit modal content to show');
                return;
            }
            
            console.log('Container children:', container.children);
            console.log('Container HTML:', container.innerHTML);
            
            // Get the modal element from the container
            const editModalElement = container.querySelector('#edit-modal');
            console.log('Edit modal element:', editModalElement);
            if (!editModalElement) {
                console.log('Edit modal element not found in container');
                return;
            }
            
            // Show the modal using Flowbite (same as client update modal)
            if (window.editModal) {
                window.editModal.show();
            } else {
                // Fallback: show the modal directly
                editModalElement.classList.remove('hidden');
                editModalElement.style.display = 'block';
            }
            
            console.log('Modal shown successfully');
        }
        
        // Function to close edit modal
        function closeEditModal() {
            // Use Flowbite modal close (same as client update modal)
            if (window.editModal) {
                window.editModal.hide();
            } else {
                // Fallback: hide the modal directly
                const modal = document.getElementById('edit-modal');
                if (modal) {
                    modal.classList.add('hidden');
                    modal.style.display = 'none';
                }
            }
            
            // Clear the form container
            const container = document.getElementById('edit-modal-form-container');
            if (container) {
                container.innerHTML = '';
            }
        }
        

        

        
        // Function to reset edit modal state
        function resetEditModalState() {
            // Clear the edit modal container
            const container = document.getElementById('edit-modal-container');
            if (container) {
                container.innerHTML = '';
            }
        }
        
        // Add event listener for modal close to reset state
        document.addEventListener('htmx:afterRequest', function(event) {
            if (event.detail.target.id === 'details-modal-container') {
                // Modal content loaded, ensure it's visible
                setTimeout(() => {
                    const container = event.detail.target;
                    if (container.children.length > 0) {
                        container.style.display = 'block';
                    }
                }, 50);
            }
            if (event.detail.target.id === 'edit-modal-container') {
                // Edit modal content loaded, ensure it's visible
                setTimeout(() => {
                    const container = event.detail.target;
                    if (container.children.length > 0) {
                        container.style.display = 'block';
                    }
                }, 50);
            }
        });
        
        // Add event listener for modal hide to reset state
        document.addEventListener('htmx:beforeRequest', function(event) {
            if (event.detail.target.id === 'details-modal-container') {
                // Reset modal state before loading new content
                resetModalState();
            }
            if (event.detail.target.id === 'edit-modal-container') {
                // Reset edit modal state before loading new content
                resetEditModalState();
            }
        });



        const documentModalElement = document.getElementById('document-modal');
        window.documentModal = new Modal(documentModalElement, modalOptions, {
            id: 'document-modal',
            override: true
        });

        const tasksModalElement = document.getElementById('tasks-modal');
        if (tasksModalElement) {
            window.tasksModal = new Modal(tasksModalElement, modalOptions, {
                id: 'tasks-modal',
                override: true
            });
        }

        const taskNewModalElement = document.getElementById('task-new-modal');
        if (taskNewModalElement) {
            window.taskNewModal = new Modal(taskNewModalElement, modalOptions, {
                id: 'task-new-modal',
                override: true
            });
        }
        
        // Initialize edit modal
        const editModalElement = document.getElementById('edit-modal');
        if (editModalElement) {
            window.editModal = new Modal(editModalElement, modalOptions, {
                id: 'edit-modal',
                override: true
            });
        }

        {% if request.GET.transaction_id %}
            htmx.ajax('GET', "{% url 'transaction_support:transaction_detail' request.GET.transaction_id %}", {
                target: '#details-modal-container',
                indicator: '#details-modal-overlay'
            }).then(function (response) {
                console.log("Here")
                setTimeout(showDetailsModal, 100)
            })

        {% endif %}

        function openTasksModal(transactionId, transactionTitle, taskCount) {
            const transactionData = document.querySelector(`[data-transaction-id="${transactionId}"]`);
            
            // Update modal title and task count
            const modalTitleElement = document.querySelector('#tasks-modal h3');
            if (modalTitleElement) {
                modalTitleElement.textContent = `${transactionTitle} Tasks (${taskCount})`;
            }
            
            // Update task count badge
            const taskCountBadge = document.getElementById('taskCountBadge');
            if (taskCountBadge) {
                taskCountBadge.textContent = taskCount;
            }
            
            // Store current transaction data for task creation
            window.currentTransactionData = {
                id: transactionId,
                title: transactionTitle,
                taskCount: taskCount
            };
        }

        // Function to open the add task modal
        function openAddTaskModal() {
            if (!window.currentTransactionData) {
                alert('Please select a transaction first.');
                return;
            }
            
            console.log('Current transaction data:', window.currentTransactionData);
            console.log('Transaction ID:', window.currentTransactionData.id);
            
            // Close the tasks modal
            if (window.tasksModal) {
                window.tasksModal.hide();
            }
            
            // Load the form via HTMX and then show the modal
            htmx.ajax('GET', `/transaction/transactions/${window.currentTransactionData.id}/tasks/create/`, {
                target: '#task-new-modal-container',
                swap: 'innerHTML'
            }).then(() => {
                // Open the task creation modal after form is loaded
                if (window.taskNewModal) {
                    window.taskNewModal.show();
                }
                
                // Pre-fill the transaction field if it exists
                setTimeout(() => {
                    const transactionSelect = document.querySelector('#task-new-modal select[name="transaction"]');
                    if (transactionSelect && window.currentTransactionData.id) {
                        transactionSelect.value = window.currentTransactionData.id;
                    }
                    
                    // If there's a transaction title field, pre-fill it
                    const transactionTitleField = document.querySelector('#task-new-modal input[name="transaction_title"]');
                    if (transactionTitleField) {
                        transactionTitleField.value = window.currentTransactionData.title;
                    }
                }, 100);
            });
        }

        // Handle successful task creation
        document.addEventListener('htmx:afterSwap', function(event) {
            if (event.target.id === 'task-new-modal-container') {
                // Check if the response contains a success message or redirect
                const response = event.detail.xhr.responseText;
                if (response.includes('success') || event.detail.xhr.status === 200) {
                    // Close the task creation modal
                    if (window.taskNewModal) {
                        window.taskNewModal.hide();
                    }
                    
                    // Refresh the tasks modal if it's open
                    if (window.currentTransactionData) {
                        // Trigger a refresh of the tasks modal
                        const tasksButton = document.querySelector(`[data-transaction-id="${window.currentTransactionData.id}"] .tasks-btn`);
                        if (tasksButton) {
                            tasksButton.click();
                        }
                    }
                    
                    // Show success message
                    showToast('Task created successfully!', 'success');
                }
            }
        });

        // Toast notification function
        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            } transition-all duration-300 transform translate-x-full`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
    </script>

{% endblock %}