{% extends "kyc_app/kyc_base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block kyc_content %}
<div class="flex justify-center items-center min-h-screen bg-gray-100 p-6 text-sm">
  <div class="w-full max-w-5xl bg-white shadow-md rounded-lg p-6">
    <h2 class="text-lg font-bold text-gray-800 text-center mb-6">
      Register KYC Profile
    </h2>
    
    <!-- Optional: Display Django messages -->
    {% if messages %}
      <div class="mb-4">
        {% for message in messages %}
          <div class="p-4 mb-2 text-sm {% if message.tags == 'success' %}text-green-700 bg-green-100{% elif message.tags == 'error' %}text-red-700 bg-red-100{% else %}text-gray-700 bg-gray-100{% endif %} rounded-lg" role="alert">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
    
    <form method="POST" enctype="multipart/form-data" class="space-y-6">
      {% csrf_token %}
      
      <!-- Personal Information -->
      <div class="bg-gray-100 p-4 rounded-md">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Personal Information</h3>
        <div class="grid grid-cols-2 gap-4">
          <!-- Customer ID -->
          <div>
            <label for="{{ form.customer_id.id_for_label }}" class="block text-xs text-gray-700 font-semibold">
              Customer ID
            </label>
            {{ form.customer_id|add_class:"rounded-md border border-gray-300 p-1 w-32 text-xs" }}
          </div>
          <!-- Full Name -->
          <div>
            <label for="{{ form.full_name.id_for_label }}" class="block text-xs text-gray-700 font-semibold">
              Full Name
            </label>
            {{ form.full_name|add_class:"rounded-md border border-gray-300 p-1 text-xs" }}
          </div>
          <!-- Date of Birth -->
          <div>
            <label for="{{ form.date_of_birth.id_for_label }}" class="block text-xs text-gray-700 font-semibold">
              Date of Birth
            </label>
            {{ form.date_of_birth|add_class:"rounded-md border border-gray-300 p-1 text-xs" }}
          </div>
          <!-- Nationality (Dropdown populated dynamically) -->
          <div>
            <label for="id_nationality" class="block text-xs text-gray-700 font-semibold">Nationality</label>
            <select name="{{ form.nationality.name }}" id="id_nationality" class="w-full border border-gray-300 p-2 rounded-md text-xs">
              <option value="">Select Nationality</option>
            </select>
          </div>
          <!-- Gender -->
          <div>
            <label for="{{ form.gender.id_for_label }}" class="block text-xs text-gray-700 font-semibold">
              Gender
            </label>
            {{ form.gender|add_class:"rounded-md border border-gray-300 text-xs" }}
          </div>
        </div>
      </div>
      
      <!-- Identification Documents -->
      <div class="bg-gray-100 p-4 rounded-md">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Identification Documents</h3>
        <div class="grid grid-cols-2 gap-4">
          <!-- ID Document Type -->
          <div>
            <label for="{{ form.id_document_type.id_for_label }}" class="block text-xs text-gray-700 font-semibold">
              ID Document Type
            </label>
            {{ form.id_document_type|add_class:"rounded-md border border-gray-300 p-1 text-xs" }}
          </div>
          <!-- ID Document Number -->
          <div>
            <label for="{{ form.id_document_number.id_for_label }}" class="block text-xs text-gray-700 font-semibold">
              ID Document Number
            </label>
            {{ form.id_document_number|add_class:"rounded-md border border-gray-300 p-1 text-xs" }}
          </div>
          <!-- ID Issued Country (Dropdown populated dynamically) -->
          <div>
            <label for="id_issued_country" class="block text-xs text-gray-700 font-semibold">ID Issued Country</label>
            <select name="{{ form.id_issued_country.name }}" id="id_issued_country" class="w-full border border-gray-300 p-2 rounded-md text-xs">
              <option value="">Select Country</option>
            </select>
          </div>
          <!-- ID Expiry Date -->
          <div>
            <label for="{{ form.id_expiry_date.id_for_label }}" class="block text-xs text-gray-700 font-semibold">
              ID Expiry Date
            </label>
            {{ form.id_expiry_date|add_class:"rounded-md border border-gray-300 p-1 text-xs" }}
          </div>
          <!-- Upload ID Document File -->
          <div class="col-span-2">
            <label for="{{ form.id_document_file.id_for_label }}" class="block text-xs text-gray-700 font-semibold">
              Upload ID Document
            </label>
            {{ form.id_document_file|add_class:"rounded-md border border-gray-300 p-1 text-xs" }}
          </div>
        </div>
      </div>
      
      <!-- Contact Information -->
      <div class="bg-gray-100 p-4 rounded-md">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Contact Information</h3>
        <div class="grid grid-cols-2 gap-4">
          <!-- Email -->
          <div>
            <label for="{{ form.email.id_for_label }}" class="block text-xs text-gray-700 font-semibold">
              Email
            </label>
            {{ form.email|add_class:"rounded-md border border-gray-300 p-1 text-xs" }}
          </div>
          <!-- Phone Number -->
          <div>
            <label for="{{ form.phone_number.id_for_label }}" class="block text-xs text-gray-700 font-semibold">
              Phone Number
            </label>
            {{ form.phone_number|add_class:"rounded-md border border-gray-300 p-1 text-xs" }}
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4 mt-3">
          <!-- Address -->
          <div>
            <label for="{{ form.address.id_for_label }}" class="block text-xs text-gray-700 font-semibold">
              Address
            </label>
            {{ form.address|add_class:"rounded-md border border-gray-300 p-1 text-xs" }}
          </div>
          <!-- City (Dropdown with static sample options) -->
          <div>
            <label for="id_city" class="block text-xs text-gray-700 font-semibold">City</label>
            <select name="{{ form.city.name }}" id="id_city" class="w-full border border-gray-300 p-2 rounded-md text-xs">
              <option value="">Select City</option>
              <option value="New York">New York</option>
              <option value="London">London</option>
              <option value="Toronto">Toronto</option>
              <option value="Mexico City">Mexico City</option>
              <option value="Beijing">Beijing</option>
              <option value="Mumbai">Mumbai</option>
              <option value="Berlin">Berlin</option>
              <option value="Paris">Paris</option>
              <option value="Sydney">Sydney</option>
            </select>
          </div>
          <!-- Country (Dropdown populated dynamically) -->
          <div>
            <label for="id_country" class="block text-xs text-gray-700 font-semibold">Country</label>
            <select name="{{ form.country.name }}" id="id_country" class="w-full border border-gray-300 p-2 rounded-md text-xs">
              <option value="">Select Country</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Employment & Financial Information -->
      <div class="bg-gray-100 p-4 rounded-md">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Employment & Financial Information</h3>
        <div class="grid grid-cols-2 gap-4">
          <!-- Occupation -->
          <div>
            <label for="{{ form.occupation.id_for_label }}" class="block text-xs text-gray-700 font-semibold">
              Occupation
            </label>
            {{ form.occupation|add_class:"rounded-md border border-gray-300 p-1 text-xs" }}
          </div>
          <!-- Employer Name -->
          <div>
            <label for="{{ form.employer_name.id_for_label }}" class="block text-xs text-gray-700 font-semibold">
              Employer Name
            </label>
            {{ form.employer_name|add_class:"rounded-md border border-gray-300 p-1 text-xs" }}
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4 mt-3">
          <!-- Annual Income -->
          <div>
            <label for="{{ form.annual_income.id_for_label }}" class="block text-xs text-gray-700 font-semibold">
              Annual Income
            </label>
            {{ form.annual_income|add_class:"rounded-md border border-gray-300 p-1 text-xs" }}
          </div>
          <!-- Source of Funds -->
          <div>
            <label for="{{ form.source_of_funds.id_for_label }}" class="block text-xs text-gray-700 font-semibold">
              Source of Funds
            </label>
            {{ form.source_of_funds|add_class:"rounded-md border border-gray-300 p-1 text-xs" }}
          </div>
        </div>
      </div>
      
      <!-- Banking Information -->
      <div class="bg-gray-100 p-4 rounded-md">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Banking Information</h3>
        <div class="grid grid-cols-2 gap-4">
          <!-- Account Number -->
          <div>
            <label for="{{ form.account_number.id_for_label }}" class="block text-xs text-gray-700 font-semibold">
              Account Number
            </label>
            {{ form.account_number|add_class:"rounded-md border border-gray-300 p-1 text-xs" }}
          </div>
          <!-- Account Type -->
          <div>
            <label for="{{ form.account_type.id_for_label }}" class="block text-xs text-gray-700 font-semibold">
              Account Type
            </label>
            {{ form.account_type|add_class:"rounded-md border border-gray-300 p-1 w-[20%] text-xs" }}
          </div>
          <!-- Account Status -->
          <div>
            <label for="{{ form.account_status.id_for_label }}" class="block text-xs text-gray-700 font-semibold">
              Account Status
            </label>
            {{ form.account_status|add_class:"rounded-md border border-gray-300 p-1 w-[20%] text-xs" }}
          </div>
        </div>
      </div>
      
      <!-- Submit Button -->
      <div class="flex justify-end mt-4">
        <button type="submit" class="px-6 py-2 bg-[#f68430] text-white font-semibold rounded-md hover:bg-orange-300 transition">
          Register
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Script to fetch dynamic country data from the REST Countries API -->
<script>
  async function fetchCountriesAndNationalities() {
    try {
      const response = await fetch("https://restcountries.com/v3.1/all");
      const countries = await response.json();
      countries.sort((a, b) => a.name.common.localeCompare(b.name.common));

      // Get dropdown elements
      const countrySelect = document.getElementById("id_country");
      const issuedCountrySelect = document.getElementById("id_issued_country");
      const nationalitySelect = document.getElementById("id_nationality");

      // Clear default options
      countrySelect.innerHTML = '<option value="">Select Country</option>';
      issuedCountrySelect.innerHTML = '<option value="">Select Country</option>';
      nationalitySelect.innerHTML = '<option value="">Select Nationality</option>';

      countries.forEach(country => {
        const countryName = country.name.common;

        // Populate Country Dropdown
        const optionCountry = document.createElement("option");
        optionCountry.value = countryName;
        optionCountry.textContent = countryName;
        countrySelect.appendChild(optionCountry);

        // Populate ID Issued Country Dropdown
        const optionIssued = document.createElement("option");
        optionIssued.value = countryName;
        optionIssued.textContent = countryName;
        issuedCountrySelect.appendChild(optionIssued);

        // Populate Nationality Dropdown (using demonym if available)
        let demonym = country.demonyms && country.demonyms.eng ? country.demonyms.eng.m : countryName;
        const optionNationality = document.createElement("option");
        optionNationality.value = demonym;
        optionNationality.textContent = demonym;
        nationalitySelect.appendChild(optionNationality);
      });
    } catch (error) {
      console.error("Error fetching countries:", error);
    }
  }

  document.addEventListener("DOMContentLoaded", fetchCountriesAndNationalities);
</script>
{% endblock kyc_content %}

