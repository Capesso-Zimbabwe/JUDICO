{% extends "kyc_app/kyc_base.html" %}
{% load static %}

{% block kyc_content %}
<!-- Scrollable Content Wrapper -->
<div class="h-full overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400">
<div class="bg-gray-100 min-h-screen p-6">
    <!-- Header Section -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-lg font-bold text-gray-900">AML Screening</h1>
            <p class="text-xs text-gray-600 mt-1">Individual Check & Screening</p>
        </div>
        <div class="flex space-x-3">
            {% if results %}
            <a href="{% url 'kyc_app:download_report' %}?query={{ request.GET.query|urlencode }}&source_type={{ request.GET.source_type|default:'ALL'|urlencode }}" 
               class="inline-flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Download Report
            </a>
            {% endif %}
        </div>
    </div>
    
    <!-- Search Form -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-6">
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                Search Individual
            </h3>
        </div>
        <div class="p-6">
            <form
                id="searchForm"
                method="GET"
                action="{% url 'kyc_app:check_individual' %}"
                class="flex flex-col md:flex-row"
            >
                <input
                    id="search_query"
                    type="text"
                    name="query"
                    placeholder="Search for a person or company..."
                    class="flex-1 border border-gray-300 rounded-none p-2 md:rounded-r-none focus:ring-1 focus:ring-airtable-blue focus:border-transparent text-xs font-bold"
                    value="{{ request.GET.query|default:'' }}"
                    required
                />
                
                <!-- Hidden input to store the filter (source_type) -->
                <input
                    type="hidden"
                    name="source_type"
                    id="sourceType"
                    value="{{ request.GET.source_type|default:'ALL' }}"
                />
                
                <!-- Search Button -->
                <button
                    type="submit"
                    class="p-2 flex gap-1 bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors duration-200 mt-2 md:mt-0"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <span class="font-bold text-xs">Search</span>
                </button>
            </form>
        </div>
    </div>

    {% if error %}
    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded-md">
        {{ error }}
    </div>
    {% endif %}

    {% if results %}
    <!-- Filter Tabs -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-6">
        <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
            <h3 class="text-sm font-semibold text-gray-900 flex items-center">
                <svg class="w-4 h-4 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.414A1 1 0 013 6.707V4z"></path>
                </svg>
                Filter Results
            </h3>
        </div>
        <div class="p-6">
            <div class="inline-flex flex-wrap bg-gray-100 rounded-lg p-1">
                <a href="javascript:void(0)" data-filter="ALL" 
                   class="tab-link px-2 py-1 text-xs font-medium {% if request.GET.source_type == 'ALL' or not request.GET.source_type %}bg-white text-blue-600 shadow-sm{% else %}text-gray-700 hover:text-gray-900{% endif %} transition-all duration-200 rounded-md">ALL</a>
                <a href="javascript:void(0)" data-filter="SANCTION" 
                   class="tab-link px-2 py-1 text-xs font-medium {% if request.GET.source_type == 'SANCTION' %}bg-white text-red-600 shadow-sm{% else %}text-gray-700 hover:text-gray-900{% endif %} transition-all duration-200 rounded-md">SANCTIONS</a>
                <a href="javascript:void(0)" data-filter="PEP" 
                   class="tab-link px-2 py-1 text-xs font-medium {% if request.GET.source_type == 'PEP' %}bg-white text-yellow-600 shadow-sm{% else %}text-gray-700 hover:text-gray-900{% endif %} transition-all duration-200 rounded-md">PEPS</a>
                <a href="javascript:void(0)" data-filter="CRIMINAL" 
                   class="tab-link px-2 py-1 text-xs font-medium {% if request.GET.source_type == 'CRIMINAL' %}bg-white text-gray-800 shadow-sm{% else %}text-gray-700 hover:text-gray-900{% endif %} transition-all duration-200 rounded-md">CRIMINALS</a>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="bg-gradient-to-r from-indigo-50 to-blue-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-sm font-semibold text-gray-900 flex items-center">
                <svg class="w-4 h-4 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                </svg>
                Search Results ({{ results.total_hits }})
            </h3>
        </div>
        <div class="p-6">
            {% if results.found_records %}
                <div class="space-y-4 max-h-screen overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400">
                {% for record in results.found_records %}
                <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden hover:shadow-md transition-shadow duration-200">
                    <!-- Record Header (Collapsible Trigger) -->
                    <div class="flex justify-between items-center p-6 cursor-pointer hover:bg-gray-50 transition-colors duration-200" onclick="toggleDetails('details-{{ forloop.counter }}')">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-8 w-8 mr-3">
                                <div class="h-8 w-8 rounded-full {% if record.source_type == 'PEP' %}bg-yellow-100{% elif record.source_type == 'SANCTION' %}bg-red-100{% elif record.source_type == 'CRIMINAL' %}bg-gray-100{% else %}bg-blue-100{% endif %} flex items-center justify-center">
                                    <span class="text-xs font-medium {% if record.source_type == 'PEP' %}text-yellow-600{% elif record.source_type == 'SANCTION' %}text-red-600{% elif record.source_type == 'CRIMINAL' %}text-gray-600{% else %}text-blue-600{% endif %}">{{ record.name|first|upper }}</span>
                                </div>
                            </div>
                            <div>
                                <div class="flex items-center">
                                    <h3 class="text-sm font-semibold text-gray-900 mr-3">{{ record.name }}</h3>
                                    {% if record.source_type == 'PEP' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">PEP</span>
                                    {% elif record.source_type == 'SANCTION' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">SANCTION</span>
                                    {% elif record.source_type == 'CRIMINAL' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">CRIMINAL</span>
                                    {% endif %}
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Source ID: {{ record.source_id }}</p>
                            </div>
                        </div>
                        <div>
                            <button class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200 hover:text-gray-700 transition-all duration-200 shadow-sm hover:shadow-md">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Collapsible Details -->
                    <div id="details-{{ forloop.counter }}" class="hidden border-t border-gray-200 bg-gray-50">
                        <div class="p-6">
                            <div class="max-h-96 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-gray-200 hover:scrollbar-thumb-gray-500">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        {% if record.source_type %}
                                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                                            <th class="px-3 py-1 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-50 w-1/4">Source Type:</th>
                                            <td class="px-3 py-1 whitespace-nowrap text-xs text-gray-900">{{ record.source_type }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if record.source_id %}
                                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                                            <th class="px-3 py-1 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-50 w-1/4">Source ID:</th>
                                            <td class="px-3 py-1 whitespace-nowrap text-xs text-gray-900">{{ record.source_id }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if record.id %}
                                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                                            <th class="px-3 py-1 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-50 w-1/4">Unique ID:</th>
                                            <td class="px-3 py-1 whitespace-nowrap text-xs text-gray-900">{{ record.id }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if record.entity_type %}
                                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                                            <th class="px-3 py-1 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-50 w-1/4">Entity Type:</th>
                                            <td class="px-3 py-1 whitespace-nowrap text-xs text-gray-900">{{ record.entity_type }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if record.gender %}
                                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                                            <th class="px-3 py-1 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-50 w-1/4">Gender:</th>
                                            <td class="px-3 py-1 whitespace-nowrap text-xs text-gray-900">{{ record.gender }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if record.date_of_birth %}
                                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                                            <th class="px-3 py-1 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-50 w-1/4">Date of Birth:</th>
                                            <td class="px-3 py-1 text-xs text-gray-900">{{ record.date_of_birth|join:", " }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if record.citizenship %}
                                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                                            <th class="px-3 py-1 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-50 w-1/4">Citizenship:</th>
                                            <td class="px-3 py-1 text-xs text-gray-900">{{ record.citizenship|join:", " }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if record.occupations %}
                                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                                            <th class="px-3 py-1 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-50 w-1/4">Occupations:</th>
                                            <td class="px-3 py-1 text-xs text-gray-900">{{ record.occupations|join:", " }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if record.positions %}
                                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                                            <th class="px-3 py-1 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-50 w-1/4">Positions:</th>
                                            <td class="px-3 py-1 text-xs text-gray-900">{{ record.positions|join:", " }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if record.address %}
                                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                                            <th class="px-3 py-1 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-50 w-1/4">Address:</th>
                                            <td class="px-3 py-1 text-xs text-gray-900">{{ record.address|join:"<br>"|safe }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if record.sanction_details %}
                                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                                            <th class="px-3 py-1 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-50 w-1/4">Sanction Details:</th>
                                            <td class="px-3 py-1 text-xs text-gray-900">{{ record.sanction_details|join:", " }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if record.description %}
                                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                                            <th class="px-3 py-1 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-50 w-1/4">Description:</th>
                                            <td class="px-3 py-1 text-xs text-gray-900">{{ record.description|join:", " }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if record.links %}
                                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                                            <th class="px-3 py-1 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-50 w-1/4">Links:</th>
                                            <td class="px-3 py-1 text-xs text-gray-900">
                                                {% for link in record.links %}
                                                    <a href="{{ link }}" target="_blank" class="text-blue-600 hover:text-blue-800 underline break-all">{{ link }}</a>{% if not forloop.last %}<br>{% endif %}
                                                {% endfor %}
                                            </td>
                                        </tr>
                                        {% endif %}
                                        {% if record.titles %}
                                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                                            <th class="px-3 py-1 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-50 w-1/4">Titles:</th>
                                            <td class="px-3 py-1 text-xs text-gray-900">{{ record.titles|join:", " }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if record.functions %}
                                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                                            <th class="px-3 py-1 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-50 w-1/4">Functions:</th>
                                            <td class="px-3 py-1 text-xs text-gray-900">{{ record.functions|join:", " }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if record.other_information %}
                                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                                            <th class="px-3 py-1 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-50 w-1/4">Other Info:</th>
                                            <td class="px-3 py-1 text-xs text-gray-900">{{ record.other_information|join:", " }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if record.source_country %}
                                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                                            <th class="px-3 py-1 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-50 w-1/4">Source Country:</th>
                                            <td class="px-3 py-1 text-xs text-gray-900">{{ record.source_country }}</td>
                                        </tr>
                                        {% endif %}
                            </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="bg-blue-50 text-blue-700 p-4 rounded-md">
                    No records found matching your search criteria.
                </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

{% block scripts %}
<script>
    // Toggle function for collapsible details
    function toggleDetails(id) {
        var element = document.getElementById(id);
        if (element.classList.contains('hidden')) {
            element.classList.remove('hidden');
        } else {
            element.classList.add('hidden');
        }
    }

    // Automatic form submission when user clicks filters
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('searchForm');
        const sourceTypeInput = document.getElementById('sourceType');
        const searchQuery = document.getElementById('search_query');

        document.querySelectorAll('.tab-link').forEach(link => {
            link.addEventListener('click', function() {
                sourceTypeInput.value = this.getAttribute('data-filter');
                if (searchQuery.value.trim() !== '') {
                    // re-submit the form
                    form.submit();
                }
            });
        });
    });
</script>
{% endblock scripts %}
{% endblock kyc_content %}