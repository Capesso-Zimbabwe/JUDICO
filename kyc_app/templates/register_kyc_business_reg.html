{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block sidebar %}
<ul class="p-0 m-0 list-none mt-2">
    <li>
        <a href="{% url 'kyc_app:kyc_workflow_dashboard' %}" class="sidebar-link block py-2 px-3 hover:text-custom-orange text-gray-700">
            <span class="sidebar-icon">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                </svg>
            </span>
            KYC Dashboard
        </a>
    </li>
    <li>
        <a href="{% url 'kyc_app:register_kyc_profile' %}" class="sidebar-link block py-2 px-3 hover:text-custom-orange text-gray-700">
            <span class="sidebar-icon">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                </svg>
            </span>
            Register Individual
        </a>
    </li>
    <li>
        <a href="{% url 'kyc_app:register_kyc_business' %}" class="sidebar-link block py-2 px-3 hover:text-custom-orange text-gray-700 active">
            <span class="sidebar-icon">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
            </span>
            Register Business
        </a>
    </li>
    <li>
        <a href="{% url 'kyc_app:kyc_search' %}" class="sidebar-link block py-2 px-3 hover:text-custom-orange text-gray-700">
            <span class="sidebar-icon">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </span>
            Search KYC Profiles
        </a>
    </li>
    <li>
        <a href="{% url 'kyc_app:kyc_reports' %}" class="sidebar-link block py-2 px-3 hover:text-custom-orange text-gray-700">
            <span class="sidebar-icon">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </span>
            KYC Reports
        </a>
    </li>
    <li class="absolute bottom-0 left-0 w-full border-t border-gray-700 mt-auto py-2">
        <form id="logout-form" method="post" action="{% url 'logout' %}">{% csrf_token %}</form>
        <button onclick="document.getElementById('logout-form').submit()" href="#" class="sidebar-link block w-full py-3 px-3 hover:text-white text-slate-200">
            <span class="sidebar-icon">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
            </span>
            Logout
        </button>
    </li>
</ul>
{% endblock %}

{% block content %}
  <div class="flex justify-center items-center min-h-screen bg-gray-100 p-6 text-sm">
    <div class="w-full max-w-5xl bg-white shadow-md rounded-lg p-6">
      <h2 class="text-lg font-bold text-gray-800 text-center mb-6">
        Register Business KYC Profile
      </h2>
      
      <!-- Optional: Display messages -->
      <div id="messages" class="mb-4 hidden">
        <div id="success-message" class="p-4 mb-2 text-sm text-green-700 bg-green-100 rounded-lg" role="alert">
          Form submitted successfully!
        </div>
        <div id="error-message" class="p-4 mb-2 text-sm text-red-700 bg-red-100 rounded-lg hidden" role="alert">
          There were errors in your submission. Please check the form and try again.
        </div>
      </div>
      
      <form id="businessKycForm" class="space-y-6">
        {% csrf_token %}
        <!-- Business Information -->
        <div class="bg-gray-100 p-4 rounded-md">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Business Information</h3>
          <div class="grid grid-cols-2 gap-4">
            <!-- Business ID -->
            <div>
              <label for="business_id" class="block text-xs text-gray-700 font-semibold">
                Business ID
              </label>
              <input type="text" id="business_id" name="business_id" class="rounded-md border border-gray-300 p-1 w-32 text-xs">
              <p class="text-red-500 text-xs mt-1 error-message" id="business_id_error"></p>
            </div>
            <!-- Business Name -->
            <div>
              <label for="business_name" class="block text-xs text-gray-700 font-semibold">
                Business Name
              </label>
              <input type="text" id="business_name" name="business_name" class="rounded-md border border-gray-300 p-1 text-xs w-full" required>
              <p class="text-red-500 text-xs mt-1 error-message" id="business_name_error"></p>
            </div>
            <!-- Registration Date -->
            <div>
              <label for="registration_date" class="block text-xs text-gray-700 font-semibold">
                Registration Date
              </label>
              <input type="date" id="registration_date" name="registration_date" class="rounded-md border border-gray-300 p-1 text-xs">
              <p class="text-red-500 text-xs mt-1 error-message" id="registration_date_error"></p>
            </div>
            <!-- Business Type -->
            <div>
              <label for="business_type" class="block text-xs text-gray-700 font-semibold">
                Business Type
              </label>
              <select id="business_type" name="business_type" class="w-full border border-gray-300 p-2 rounded-md text-xs">
                <option value="">Select Business Type</option>
                <option value="sole_proprietorship">Sole Proprietorship</option>
                <option value="partnership">Partnership</option>
                <option value="llc">Limited Liability Company (LLC)</option>
                <option value="corporation">Corporation</option>
                <option value="nonprofit">Non-Profit Organization</option>
                <option value="trust">Trust</option>
                <option value="other">Other</option>
              </select>
              <p class="text-red-500 text-xs mt-1 error-message" id="business_type_error"></p>
            </div>
            <!-- Industry Sector -->
            <div>
              <label for="industry_sector" class="block text-xs text-gray-700 font-semibold">
                Industry Sector
              </label>
              <select id="industry_sector" name="industry_sector" class="w-full border border-gray-300 p-2 rounded-md text-xs">
                <option value="">Select Industry Sector</option>
                <option value="agriculture">Agriculture</option>
                <option value="manufacturing">Manufacturing</option>
                <option value="retail">Retail</option>
                <option value="technology">Technology</option>
                <option value="healthcare">Healthcare</option>
                <option value="finance">Finance & Insurance</option>
                <option value="construction">Construction</option>
                <option value="transportation">Transportation</option>
                <option value="hospitality">Hospitality</option>
                <option value="education">Education</option>
                <option value="other">Other</option>
              </select>
              <p class="text-red-500 text-xs mt-1 error-message" id="industry_sector_error"></p>
            </div>
          </div>
        </div>
        
        <!-- Registration Documents -->
        <div class="bg-gray-100 p-4 rounded-md">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Registration Documents</h3>
          <div class="grid grid-cols-2 gap-4">
            <!-- Registration Number -->
            <div>
              <label for="registration_number" class="block text-xs text-gray-700 font-semibold">
                Registration Number
              </label>
              <input type="text" id="registration_number" name="registration_number" class="rounded-md border border-gray-300 p-1 text-xs" required>
              <p class="text-red-500 text-xs mt-1 error-message" id="registration_number_error"></p>
            </div>
            <!-- Tax ID Number -->
            <div>
              <label for="tax_id_number" class="block text-xs text-gray-700 font-semibold">
                Tax ID Number
              </label>
              <input type="text" id="tax_id_number" name="tax_id_number" class="rounded-md border border-gray-300 p-1 text-xs" required>
              <p class="text-red-500 text-xs mt-1 error-message" id="tax_id_number_error"></p>
            </div>
            <!-- Country of Registration -->
            <div>
              <label for="registration_country" class="block text-xs text-gray-700 font-semibold">
                Country of Registration
              </label>
              <select id="registration_country" name="registration_country" class="w-full border border-gray-300 p-2 rounded-md text-xs">
                <option value="">Select Country</option>
              </select>
              <p class="text-red-500 text-xs mt-1 error-message" id="registration_country_error"></p>
            </div>
            <!-- License Expiry Date -->
            <div>
              <label for="license_expiry_date" class="block text-xs text-gray-700 font-semibold">
                License Expiry Date
              </label>
              <input type="date" id="license_expiry_date" name="license_expiry_date" class="rounded-md border border-gray-300 p-1 text-xs">
              <p class="text-red-500 text-xs mt-1 error-message" id="license_expiry_date_error"></p>
            </div>
            <!-- Upload Business Registration Document -->
            <div>
              <label for="registration_document" class="block text-xs text-gray-700 font-semibold">
                Upload Registration Document
              </label>
              <input type="file" id="registration_document" name="registration_document" class="rounded-md border border-gray-300 p-1 text-xs">
              <p class="text-red-500 text-xs mt-1 error-message" id="registration_document_error"></p>
            </div>
            <!-- Upload Tax Registration Document -->
            <div>
              <label for="tax_document" class="block text-xs text-gray-700 font-semibold">
                Upload Tax Registration
              </label>
              <input type="file" id="tax_document" name="tax_document" class="rounded-md border border-gray-300 p-1 text-xs">
              <p class="text-red-500 text-xs mt-1 error-message" id="tax_document_error"></p>
            </div>
          </div>
        </div>
        
        <!-- Contact Information -->
        <div class="bg-gray-100 p-4 rounded-md">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Business Contact Information</h3>
          <div class="grid grid-cols-2 gap-4">
            <!-- Business Email -->
            <div>
              <label for="business_email" class="block text-xs text-gray-700 font-semibold">
                Business Email
              </label>
              <input type="email" id="business_email" name="business_email" class="rounded-md border border-gray-300 p-1 text-xs" required>
              <p class="text-red-500 text-xs mt-1 error-message" id="business_email_error"></p>
            </div>
            <!-- Business Phone Number -->
            <div>
              <label for="business_phone" class="block text-xs text-gray-700 font-semibold">
                Business Phone Number
              </label>
              <input type="tel" id="business_phone" name="business_phone" class="rounded-md border border-gray-300 p-1 text-xs">
              <p class="text-red-500 text-xs mt-1 error-message" id="business_phone_error"></p>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 mt-3">
            <!-- Business Address -->
            <div>
              <label for="business_address" class="block text-xs text-gray-700 font-semibold">
                Business Address
              </label>
              <input type="text" id="business_address" name="business_address" class="rounded-md border border-gray-300 p-1 text-xs w-full" required>
              <p class="text-red-500 text-xs mt-1 error-message" id="business_address_error"></p>
            </div>
            <!-- City -->
            <div>
              <label for="business_city" class="block text-xs text-gray-700 font-semibold">City</label>
              <select id="business_city" name="business_city" class="w-full border border-gray-300 p-2 rounded-md text-xs">
                <option value="">Select City</option>
                <option value="New York">New York</option>
                <option value="London">London</option>
                <option value="Toronto">Toronto</option>
                <option value="Mexico City">Mexico City</option>
                <option value="Beijing">Beijing</option>
                <option value="Mumbai">Mumbai</option>
                <option value="Berlin">Berlin</option>
                <option value="Paris">Paris</option>
                <option value="Sydney">Sydney</option>
              </select>
              <p class="text-red-500 text-xs mt-1 error-message" id="business_city_error"></p>
            </div>
            <!-- Country -->
            <div>
              <label for="business_country" class="block text-xs text-gray-700 font-semibold">Country</label>
              <select id="business_country" name="business_country" class="w-full border border-gray-300 p-2 rounded-md text-xs">
                <option value="">Select Country</option>
              </select>
              <p class="text-red-500 text-xs mt-1 error-message" id="business_country_error"></p>
            </div>
            <!-- Website -->
            <div>
              <label for="business_website" class="block text-xs text-gray-700 font-semibold">
                Business Website
              </label>
              <input type="url" id="business_website" name="business_website" class="rounded-md border border-gray-300 p-1 text-xs w-full">
              <p class="text-red-500 text-xs mt-1 error-message" id="business_website_error"></p>
            </div>
          </div>
        </div>
        
        <!-- Ownership & Beneficial Owners -->
        <div class="bg-gray-100 p-4 rounded-md">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Ownership Structure & Beneficial Owners</h3>
          
          <!-- Ownership Structure -->
          <div class="mb-4">
            <label for="ownership_structure" class="block text-xs text-gray-700 font-semibold mb-2">
              Ownership Structure
            </label>
            <select id="ownership_structure" name="ownership_structure" class="w-full border border-gray-300 p-2 rounded-md text-xs">
              <option value="">Select Ownership Structure</option>
              <option value="single_owner">Single Owner</option>
              <option value="multiple_partners">Multiple Partners</option>
              <option value="public_company">Public Company</option>
              <option value="private_company">Private Company</option>
              <option value="government_owned">Government Owned</option>
              <option value="other">Other</option>
            </select>
            <p class="text-red-500 text-xs mt-1 error-message" id="ownership_structure_error"></p>
          </div>
          
          <!-- Beneficial Owner Section -->
          <div id="beneficial_owners_section">
            <div class="flex justify-between items-center mb-3">
              <h4 class="text-md font-semibold text-gray-700">Beneficial Owner #1</h4>
              <button type="button" id="add_owner" class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">+ Add Owner</button>
            </div>
            
            <div class="beneficial-owner border border-gray-200 p-3 rounded mb-3">
              <div class="grid grid-cols-2 gap-4">
                <!-- Owner Full Name -->
                <div>
                  <label for="owner_name_1" class="block text-xs text-gray-700 font-semibold">
                    Full Name
                  </label>
                  <input type="text" id="owner_name_1" name="owner_name_1" class="rounded-md border border-gray-300 p-1 text-xs w-full">
                  <p class="text-red-500 text-xs mt-1 error-message" id="owner_name_1_error"></p>
                </div>
                <!-- Owner Nationality -->
                <div>
                  <label for="owner_nationality_1" class="block text-xs text-gray-700 font-semibold">
                    Nationality
                  </label>
                  <select id="owner_nationality_1" name="owner_nationality_1" class="w-full border border-gray-300 p-2 rounded-md text-xs">
                    <option value="">Select Nationality</option>
                  </select>
                  <p class="text-red-500 text-xs mt-1 error-message" id="owner_nationality_1_error"></p>
                </div>
                <!-- Owner ID Type -->
                <div>
                  <label for="owner_id_type_1" class="block text-xs text-gray-700 font-semibold">
                    ID Document Type
                  </label>
                  <select id="owner_id_type_1" name="owner_id_type_1" class="rounded-md border border-gray-300 p-1 text-xs">
                    <option value="">Select ID Type</option>
                    <option value="passport">Passport</option>
                    <option value="national_id">National ID</option>
                    <option value="drivers_license">Driver's License</option>
                    <option value="other">Other</option>
                  </select>
                  <p class="text-red-500 text-xs mt-1 error-message" id="owner_id_type_1_error"></p>
                </div>
                <!-- Owner ID Number -->
                <div>
                  <label for="owner_id_number_1" class="block text-xs text-gray-700 font-semibold">
                    ID Document Number
                  </label>
                  <input type="text" id="owner_id_number_1" name="owner_id_number_1" class="rounded-md border border-gray-300 p-1 text-xs">
                  <p class="text-red-500 text-xs mt-1 error-message" id="owner_id_number_1_error"></p>
                </div>
                <!-- Ownership Percentage -->
                <div>
                  <label for="ownership_percentage_1" class="block text-xs text-gray-700 font-semibold">
                    Ownership Percentage
                  </label>
                  <input type="number" id="ownership_percentage_1" name="ownership_percentage_1" min="0" max="100" class="rounded-md border border-gray-300 p-1 w-20 text-xs">
                  <p class="text-red-500 text-xs mt-1 error-message" id="ownership_percentage_1_error"></p>
                </div>
                <!-- PEP Status -->
                <div>
                  <label for="pep_status_1" class="block text-xs text-gray-700 font-semibold">
                    PEP Status
                  </label>
                  <select id="pep_status_1" name="pep_status_1" class="rounded-md border border-gray-300 p-1 text-xs">
                    <option value="no">Not a PEP</option>
                    <option value="yes">Politically Exposed Person</option>
                    <option value="relative">Relative of a PEP</option>
                    <option value="associate">Close Associate of a PEP</option>
                  </select>
                  <p class="text-red-500 text-xs mt-1 error-message" id="pep_status_1_error"></p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Business Financial Information -->
        <div class="bg-gray-100 p-4 rounded-md">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Business Financial Information</h3>
          <div class="grid grid-cols-2 gap-4">
            <!-- Annual Revenue -->
            <div>
              <label for="annual_revenue" class="block text-xs text-gray-700 font-semibold">
                Annual Revenue
              </label>
              <select id="annual_revenue" name="annual_revenue" class="rounded-md border border-gray-300 p-1 text-xs">
                <option value="">Select Annual Revenue</option>
                <option value="less_than_100k">Less than $100,000</option>
                <option value="100k_500k">$100,000 - $500,000</option>
                <option value="500k_1m">$500,000 - $1,000,000</option>
                <option value="1m_5m">$1,000,000 - $5,000,000</option>
                <option value="5m_10m">$5,000,000 - $10,000,000</option>
                <option value="more_than_10m">More than $10,000,000</option>
              </select>
              <p class="text-red-500 text-xs mt-1 error-message" id="annual_revenue_error"></p>
            </div>
            <!-- Source of Funds -->
            <div>
              <label for="source_of_funds" class="block text-xs text-gray-700 font-semibold">
                Primary Source of Funds
              </label>
              <select id="source_of_funds" name="source_of_funds" class="rounded-md border border-gray-300 p-1 text-xs">
                <option value="">Select Source of Funds</option>
                <option value="business_revenue">Business Revenue</option>
                <option value="investments">Investments</option>
                <option value="loans">Loans/Credit</option>
                <option value="personal_capital">Personal Capital</option>
                <option value="grants">Grants/Subsidies</option>
                <option value="other">Other</option>
              </select>
              <p class="text-red-500 text-xs mt-1 error-message" id="source_of_funds_error"></p>
            </div>
          </div>
          <div class="mt-3">
            <label for="business_purpose" class="block text-xs text-gray-700 font-semibold">
              Business Activities & Purpose
            </label>
            <textarea id="business_purpose" name="business_purpose" rows="3" class="w-full rounded-md border border-gray-300 p-1 text-xs"></textarea>
            <p class="text-red-500 text-xs mt-1 error-message" id="business_purpose_error"></p>
          </div>
          <div class="grid grid-cols-2 gap-4 mt-3">
            <!-- Expected Transaction Volume -->
            <div>
              <label for="transaction_volume" class="block text-xs text-gray-700 font-semibold">
                Expected Monthly Transaction Volume
              </label>
              <select id="transaction_volume" name="transaction_volume" class="rounded-md border border-gray-300 p-1 text-xs">
                <option value="">Select Transaction Volume</option>
                <option value="less_than_10k">Less than $10,000</option>
                <option value="10k_50k">$10,000 - $50,000</option>
                <option value="50k_100k">$50,000 - $100,000</option>
                <option value="100k_500k">$100,000 - $500,000</option>
                <option value="more_than_500k">More than $500,000</option>
              </select>
              <p class="text-red-500 text-xs mt-1 error-message" id="transaction_volume_error"></p>
            </div>
            <!-- Countries of Operation -->
            <div>
              <label for="countries_of_operation" class="block text-xs text-gray-700 font-semibold">
                Primary Countries of Operation
              </label>
              <select id="countries_of_operation" name="countries_of_operation" multiple class="w-full border border-gray-300 p-2 rounded-md text-xs h-20">
                <!-- Will be populated by JavaScript -->
              </select>
              <span class="text-xs text-gray-500">Hold Ctrl/Cmd to select multiple</span>
              <p class="text-red-500 text-xs mt-1 error-message" id="countries_of_operation_error"></p>
            </div>
          </div>
        </div>
        
        <!-- Banking Information -->
        <div class="bg-gray-100 p-4 rounded-md">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Banking Information</h3>
          <div class="grid grid-cols-2 gap-4">
            <!-- Bank Name -->
            <div>
              <label for="bank_name" class="block text-xs text-gray-700 font-semibold">
                Bank Name
              </label>
              <input type="text" id="bank_name" name="bank_name" class="rounded-md border border-gray-300 p-1 text-xs">
              <p class="text-red-500 text-xs mt-1 error-message" id="bank_name_error"></p>
            </div>
            <!-- Account Number -->
            <div>
              <label for="account_number" class="block text-xs text-gray-700 font-semibold">
                Account Number
              </label>
              <input type="text" id="account_number" name="account_number" class="rounded-md border border-gray-300 p-1 text-xs">
              <p class="text-red-500 text-xs mt-1 error-message" id="account_number_error"></p>
            </div>
            <!-- Account Type -->
            <div>
              <label for="account_type" class="block text-xs text-gray-700 font-semibold">
                Account Type
              </label>
              <select id="account_type" name="account_type" class="rounded-md border border-gray-300 p-1 text-xs">
                <option value="">Select Account Type</option>
                <option value="checking">Business Checking</option>
                <option value="savings">Business Savings</option>
                <option value="investment">Investment Account</option>
                <option value="other">Other</option>
              </select>
              <p class="text-red-500 text-xs mt-1 error-message" id="account_type_error"></p>
            </div>
            <!-- Swift/BIC Code -->
            <div>
              <label for="swift_code" class="block text-xs text-gray-700 font-semibold">
                Swift/BIC Code
              </label>
              <input type="text" id="swift_code" name="swift_code" class="rounded-md border border-gray-300 p-1 text-xs">
              <p class="text-red-500 text-xs mt-1 error-message" id="swift_code_error"></p>
            </div>
          </div>
        </div>
        
        <!-- Risk Assessment and Compliance -->
        <div class="bg-gray-100 p-4 rounded-md">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Risk Assessment & Compliance</h3>
          <div class="mb-3">
            <label class="block text-xs text-gray-700 font-semibold mb-2">
              Does the business operate in high-risk jurisdictions?
            </label>
            <div class="flex space-x-4">
              <label class="inline-flex items-center">
                <input type="radio" name="high_risk_jurisdiction" value="no" class="form-radio">
                <span class="ml-2 text-xs">No</span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="high_risk_jurisdiction" value="yes" class="form-radio">
                <span class="ml-2 text-xs">Yes</span>
              </label>
            </div>
          </div>
          <div class="mb-3">
            <label class="block text-xs text-gray-700 font-semibold mb-2">
              Has the business or any of its directors/owners been subject to regulatory sanctions?
            </label>
            <div class="flex space-x-4">
              <label class="inline-flex items-center">
                <input type="radio" name="sanctions_history" value="no" class="form-radio">
                <span class="ml-2 text-xs">No</span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="sanctions_history" value="yes" class="form-radio">
                <span class="ml-2 text-xs">Yes</span>
              </label>
            </div>
          </div>
          <div class="mb-3">
            <label for="aml_policy" class="block text-xs text-gray-700 font-semibold mb-2">
              Does the business have an AML policy?
            </label>
            <div class="flex space-x-4">
              <label class="inline-flex items-center">
                <input type="radio" name="aml_policy" value="no" class="form-radio">
                <span class="ml-2 text-xs">No</span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="aml_policy" value="yes" class="form-radio">
                <span class="ml-2 text-xs">Yes</span>
              </label>
            </div>
          </div>
          <div class="mb-3">
            <label for="compliance_officer" class="block text-xs text-gray-700 font-semibold">
              Compliance Officer Name (if applicable)
            </label>
            <input type="text" id="compliance_officer" name="compliance_officer" class="rounded-md border border-gray-300 p-1 text-xs w-full">
          </div>
        </div>
        
        <!-- Declaration & Submission -->
        <div class="bg-gray-100 p-4 rounded-md">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Declaration</h3>
          <div class="mb-3">
            <label class="inline-flex items-center text-xs">
              <input type="checkbox" id="declaration_checkbox" name="declaration_checkbox" class="form-checkbox" required>
              <span class="ml-2 text-xs">I declare that the information provided in this form is true and accurate to the best of my knowledge. I understand that providing false information may result in legal consequences.</span>
            </label>
            <p class="text-red-500 text-xs mt-1 error-message" id="declaration_checkbox_error"></p>
          </div>
          <div class="mb-3">
            <label class="inline-flex items-center text-xs">
              <input type="checkbox" id="consent_checkbox" name="consent_checkbox" class="form-checkbox" required>
              <span class="ml-2 text-xs">I consent to the processing of the provided information for the purpose of anti-money laundering compliance and business verification.</span>
            </label>
            <p class="text-red-500 text-xs mt-1 error-message" id="consent_checkbox_error"></p>
          </div>
        </div>
        
        <!-- Submit Button -->
        <div class="flex justify-end mt-4">
          <button type="submit" id="submitForm" class="px-6 py-2 bg-[#f68430] text-white font-semibold rounded-md hover:bg-orange-300 transition">
            Register Business
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Script to fetch dynamic country data from the REST Countries API -->
  <script>
    async function fetchCountriesAndNationalities() {
      try {
        const response = await fetch("https://restcountries.com/v3.1/all");
        const countries = await response.json();
        countries.sort((a, b) => a.name.common.localeCompare(b.name.common));

        // Get dropdown elements
        const registrationCountrySelect = document.getElementById("registration_country");
        const businessCountrySelect = document.getElementById("business_country");
        const ownerNationalitySelect = document.getElementById("owner_nationality_1");
        const countriesOfOperationSelect = document.getElementById("countries_of_operation");

        // Clear default options
        registrationCountrySelect.innerHTML = '<option value="">Select Country</option>';
        businessCountrySelect.innerHTML = '<option value="">Select Country</option>';
        ownerNationalitySelect.innerHTML = '<option value="">Select Nationality</option>';
        countriesOfOperationSelect.innerHTML = '';

        countries.forEach(country => {
          const countryName = country.name.common;

          // Populate Registration Country Dropdown
          const optionRegistration = document.createElement("option");
          optionRegistration.value = countryName;
          optionRegistration.textContent = countryName;
          registrationCountrySelect.appendChild(optionRegistration);

          // Populate Business Country Dropdown
          const optionBusiness = document.createElement("option");
          optionBusiness.value = countryName;
          optionBusiness.textContent = countryName;
          businessCountrySelect.appendChild(optionBusiness);

          // Populate Owner Nationality Dropdown
          let demonym = country.demonyms && country.demonyms.eng ? country.demonyms.eng.m : countryName;
          const optionNationality = document.createElement("option");
          optionNationality.value = demonym;
          optionNationality.textContent = demonym;
          ownerNationalitySelect.appendChild(optionNationality);

          // Populate Countries of Operation Dropdown
          const optionOperation = document.createElement("option");
          optionOperation.value = countryName;
          optionOperation.textContent = countryName;
          countriesOfOperationSelect.appendChild(optionOperation);
        });
      } catch (error) {
        console.error("Error fetching countries:", error);
      }
    }

    // Add Beneficial Owner functionality
    let ownerCount = 1;
    
    function addBeneficialOwner() {
      ownerCount++;
      
      const newOwnerSection = document.createElement("div");
      newOwnerSection.className = "beneficial-owner border border-gray-200 p-3 rounded mb-3";
      newOwnerSection.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <h4 class="text-md font-semibold text-gray-700">Beneficial Owner #${ownerCount}</h4>
          <button type="button" class="remove-owner text-xs bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700">Remove</button>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <!-- Owner Full Name -->
          <div>
            <label for="owner_name_${ownerCount}" class="block text-xs text-gray-700 font-semibold">
              Full Name
            </label>
            <input type="text" id="owner_name_${ownerCount}" name="owner_name_${ownerCount}" class="rounded-md border border-gray-300 p-1 text-xs w-full">
            <p class="text-red-500 text-xs mt-1 error-message" id="owner_name_${ownerCount}_error"></p>
          </div>
          <!-- Owner Nationality -->
          <div>
            <label for="owner_nationality_${ownerCount}" class="block text-xs text-gray-700 font-semibold">
              Nationality
            </label>
            <select id="owner_nationality_${ownerCount}" name="owner_nationality_${ownerCount}" class="w-full border border-gray-300 p-2 rounded-md text-xs">
              <option value="">Select Nationality</option>
            </select>
            <p class="text-red-500 text-xs mt-1 error-message" id="owner_nationality_${ownerCount}_error"></p>
          </div>
          <!-- Owner ID Type -->
          <div>
            <label for="owner_id_type_${ownerCount}" class="block text-xs text-gray-700 font-semibold">
              ID Document Type
            </label>
            <select id="owner_id_type_${ownerCount}" name="owner_id_type_${ownerCount}" class="rounded-md border border-gray-300 p-1 text-xs">
              <option value="">Select ID Type</option>
              <option value="passport">Passport</option>
              <option value="national_id">National ID</option>
              <option value="drivers_license">Driver's License</option>
              <option value="other">Other</option>
            </select>
            <p class="text-red-500 text-xs mt-1 error-message" id="owner_id_type_${ownerCount}_error"></p>
          </div>
          <!-- Owner ID Number -->
          <div>
            <label for="owner_id_number_${ownerCount}" class="block text-xs text-gray-700 font-semibold">
              ID Document Number
            </label>
            <input type="text" id="owner_id_number_${ownerCount}" name="owner_id_number_${ownerCount}" class="rounded-md border border-gray-300 p-1 text-xs">
            <p class="text-red-500 text-xs mt-1 error-message" id="owner_id_number_${ownerCount}_error"></p>
          </div>
          <!-- Ownership Percentage -->
          <div>
            <label for="ownership_percentage_${ownerCount}" class="block text-xs text-gray-700 font-semibold">
              Ownership Percentage
            </label>
            <input type="number" id="ownership_percentage_${ownerCount}" name="ownership_percentage_${ownerCount}" min="0" max="100" class="rounded-md border border-gray-300 p-1 w-20 text-xs">
            <p class="text-red-500 text-xs mt-1 error-message" id="ownership_percentage_${ownerCount}_error"></p>
          </div>
          <!-- PEP Status -->
          <div>
            <label for="pep_status_${ownerCount}" class="block text-xs text-gray-700 font-semibold">
              PEP Status
            </label>
            <select id="pep_status_${ownerCount}" name="pep_status_${ownerCount}" class="rounded-md border border-gray-300 p-1 text-xs">
              <option value="no">Not a PEP</option>
              <option value="yes">Politically Exposed Person</option>
              <option value="relative">Relative of a PEP</option>
              <option value="associate">Close Associate of a PEP</option>
            </select>
            <p class="text-red-500 text-xs mt-1 error-message" id="pep_status_${ownerCount}_error"></p>
          </div>
        </div>
      `;
      document.getElementById("beneficial_owners_section").appendChild(newOwnerSection);
    }

    // Add event listener for removing an owner
    document.getElementById("beneficial_owners_section").addEventListener("click", function(event) {
      if (event.target.classList.contains("remove-owner")) {
        // Get the section to remove
        const ownerSection = event.target.closest(".beneficial-owner");
        
        // Get the owner inputs to help update validation
        const ownershipPercentageInput = ownerSection.querySelector("[name^='ownership_percentage']");
        ownerSection.remove();
        
        // Recalculate ownership percentages after removal
        const totalPercentage = validateOwnershipPercentage();
        if (!totalPercentage.valid) {
          // Show error on the first owner's percentage field
          displayError('ownership_percentage_1', totalPercentage.message);
        } else {
          // Clear any existing error
          const errorElement = document.getElementById('ownership_percentage_1_error');
          if (errorElement) {
            errorElement.textContent = '';
            document.getElementById('ownership_percentage_1').classList.remove('border-red-500');
          }
        }
      }
    });

    // Function to initialize error fields for the new owner
    function initializeOwnerErrorListeners(ownerNumber) {
      const ownerSection = document.querySelector(`.beneficial-owner:nth-child(${ownerNumber})`);
      if (!ownerSection) return;
      
      // Add input event listeners to clear errors when fixed
      const inputFields = ownerSection.querySelectorAll('input, select');
      inputFields.forEach(input => {
        input.addEventListener('input', function() {
          const errorElement = document.getElementById(`${this.id}_error`);
          if (errorElement) {
            errorElement.textContent = '';
          }
          this.classList.remove('border-red-500');
        });
      });
      
      // Add special listener for ownership percentage to recalculate totals
      const percentageInput = ownerSection.querySelector('[name^="ownership_percentage"]');
      if (percentageInput) {
        percentageInput.addEventListener('input', function() {
          const totalPercentage = validateOwnershipPercentage();
          if (!totalPercentage.valid) {
            displayError('ownership_percentage_1', totalPercentage.message);
          } else {
            const errorElement = document.getElementById('ownership_percentage_1_error');
            if (errorElement) {
              errorElement.textContent = '';
              document.getElementById('ownership_percentage_1').classList.remove('border-red-500');
            }
          }
        });
      }
    }

    // Add event listener for adding a new owner and update the addBeneficialOwner function
    document.getElementById("add_owner").addEventListener("click", function() {
      addBeneficialOwner();
      // Initialize error handling for the new owner
      initializeOwnerErrorListeners(ownerCount);
    });

    // Add event listener for form submission
    document.getElementById("businessKycForm").addEventListener("submit", async function(event) {
      event.preventDefault();
      
      // Clear previous error messages
      clearErrorMessages();

      // Validate form fields
      if (!validateForm()) {
        // Show error message
        document.getElementById('success-message').classList.add('hidden');
        document.getElementById('error-message').classList.remove('hidden');
        document.getElementById('messages').classList.remove('hidden');
        document.getElementById('error-message').textContent = 'Please correct the validation errors before submitting.';
        
        // Scroll to the top to show error messages
        window.scrollTo({ top: 0, behavior: 'smooth' });
        return;
      }

      // Collect form data
      const formData = new FormData(event.target);
      const formDataObj = {};
      formData.forEach((value, key) => {
        formDataObj[key] = value;
      });

      // Collect beneficial owners data
      const ownersData = [];
      document.querySelectorAll(".beneficial-owner").forEach(owner => {
        const ownerData = {
          full_name: owner.querySelector("[name^='owner_name']").value,
          nationality: owner.querySelector("[name^='owner_nationality']").value,
          id_document_type: owner.querySelector("[name^='owner_id_type']").value,
          id_document_number: owner.querySelector("[name^='owner_id_number']").value,
          ownership_percentage: owner.querySelector("[name^='ownership_percentage']").value,
          pep_status: owner.querySelector("[name^='pep_status']").value
        };
        ownersData.push(ownerData);
      });

      try {
        const response = await fetch('{% url "kyc_app:register_kyc_business" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify({
            form_data: formDataObj,
            owners_data: ownersData
          })
        });

        const result = await response.json();
        if (result.status === 'success') {
          document.getElementById('success-message').classList.remove('hidden');
          document.getElementById('error-message').classList.add('hidden');
          document.getElementById('messages').classList.remove('hidden');
          event.target.reset();
          // Reset beneficial owners section
          document.getElementById('beneficial_owners_section').innerHTML = '';
          addBeneficialOwner(); // Add back the first owner section
        } else {
          // Show error message and display field-specific errors
          document.getElementById('success-message').classList.add('hidden');
          document.getElementById('error-message').classList.remove('hidden');
          document.getElementById('messages').classList.remove('hidden');
          document.getElementById('error-message').textContent = result.message;
          
          // Display field-specific errors
          if (result.errors) {
            displayFieldErrors(result.errors);
          }
          
          // Scroll to the top to show error messages
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('success-message').classList.add('hidden');
        document.getElementById('error-message').classList.remove('hidden');
        document.getElementById('messages').classList.remove('hidden');
        document.getElementById('error-message').textContent = 'An error occurred while submitting the form';
      }
    });

    // Function to clear all error messages
    function clearErrorMessages() {
      // Clear all error messages
      document.querySelectorAll('.error-message').forEach(element => {
        element.textContent = '';
      });
      
      // Clear form-level error message
      document.getElementById('error-message').textContent = 'There were errors in your submission. Please check the form and try again.';
      document.getElementById('messages').classList.add('hidden');
    }

    // Function to display field-specific errors
    function displayFieldErrors(errors) {
      for (const [fieldName, errorMessages] of Object.entries(errors)) {
        const errorElement = document.getElementById(`${fieldName}_error`);
        if (errorElement) {
          errorElement.textContent = Array.isArray(errorMessages) ? errorMessages.join(' ') : errorMessages;
          
          // Also highlight the field with an error
          const inputField = document.getElementById(fieldName);
          if (inputField) {
            inputField.classList.add('border-red-500');
            
            // Add event listener to remove the error styling when the user starts fixing the field
            inputField.addEventListener('input', function() {
              this.classList.remove('border-red-500');
              document.getElementById(`${fieldName}_error`).textContent = '';
            }, { once: true });
          }
        }
      }
    }

    // Function to validate form fields before submission
    function validateForm() {
      let isValid = true;
      
      // Required fields
      const requiredFields = [
        { id: 'business_name', error: 'Business name is required' },
        { id: 'registration_number', error: 'Registration number is required' },
        { id: 'tax_id_number', error: 'Tax ID number is required' },
        { id: 'business_email', error: 'Business email is required' },
        { id: 'business_address', error: 'Business address is required' }
      ];
      
      // Validate required fields
      for (const field of requiredFields) {
        const input = document.getElementById(field.id);
        if (!input.value.trim()) {
          displayError(field.id, field.error);
          isValid = false;
        }
      }
      
      // Validate email format
      const emailInput = document.getElementById('business_email');
      if (emailInput.value.trim() && !isValidEmail(emailInput.value)) {
        displayError('business_email', 'Please enter a valid email address');
        isValid = false;
      }
      
      // Validate phone number
      const phoneInput = document.getElementById('business_phone');
      if (phoneInput.value.trim() && !isValidPhoneNumber(phoneInput.value)) {
        displayError('business_phone', 'Please enter a valid phone number');
        isValid = false;
      }
      
      // Validate website URL
      const websiteInput = document.getElementById('business_website');
      if (websiteInput.value.trim() && !isValidURL(websiteInput.value)) {
        displayError('business_website', 'Please enter a valid website URL');
        isValid = false;
      }
      
      // Validate ownership percentage total
      const totalPercentage = validateOwnershipPercentage();
      if (!totalPercentage.valid) {
        // Display error message in the first owner's percentage field
        displayError('ownership_percentage_1', totalPercentage.message);
        isValid = false;
      }
      
      // Check if declaration checkboxes are checked
      const declarationCheckbox = document.getElementById('declaration_checkbox');
      const consentCheckbox = document.getElementById('consent_checkbox');
      
      if (!declarationCheckbox.checked) {
        displayError('declaration_checkbox', 'You must accept the declaration to continue');
        isValid = false;
      }
      
      if (!consentCheckbox.checked) {
        displayError('consent_checkbox', 'You must provide consent to continue');
        isValid = false;
      }
      
      return isValid;
    }

    // Helper function to display error message for a field
    function displayError(fieldId, message) {
      const errorElement = document.getElementById(`${fieldId}_error`);
      if (errorElement) {
        errorElement.textContent = message;
        
        // Also highlight the field with an error
        const inputField = document.getElementById(fieldId);
        if (inputField) {
          inputField.classList.add('border-red-500');
          
          // Add event listener to remove the error styling when the user starts fixing the field
          inputField.addEventListener('input', function() {
            this.classList.remove('border-red-500');
            document.getElementById(`${fieldId}_error`).textContent = '';
          }, { once: true });
        }
      }
    }

    // Email validation
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    // Phone number validation
    function isValidPhoneNumber(phone) {
      // Basic phone validation - allows various formats
      const phoneRegex = /^[+]?[(]?[0-9]{3}[)]?[-\s.]?[0-9]{3}[-\s.]?[0-9]{4,6}$/;
      return phoneRegex.test(phone);
    }

    // URL validation
    function isValidURL(url) {
      try {
        new URL(url);
        return true;
      } catch (e) {
        return false;
      }
    }

    // Validate ownership percentages
    function validateOwnershipPercentage() {
      let total = 0;
      const percentageInputs = document.querySelectorAll('[name^="ownership_percentage"]');
      
      for (const input of percentageInputs) {
        const value = parseFloat(input.value) || 0;
        total += value;
      }
      
      if (total === 0) {
        return { valid: false, message: 'Total ownership percentage cannot be 0%' };
      }
      
      if (total > 100) {
        return { valid: false, message: 'Total ownership percentage exceeds 100%' };
      }
      
      return { valid: true };
    }

    // Initialize the form
    document.addEventListener('DOMContentLoaded', function() {
      fetchCountriesAndNationalities();
    });
  </script>

{% endblock %}