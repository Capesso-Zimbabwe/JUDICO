{% load static %}

<!-- Time Tracking Widget -->
<div
  id="time-tracking-widget"
  class="fixed top-4 right-4 bg-white rounded-lg shadow-lg border border-gray-200 p-4 z-50 min-w-[300px]"
>
  <div class="flex items-center justify-between mb-3">
    <h3 class="text-lg font-semibold text-gray-800">Time Tracking</h3>
    <button id="toggle-widget" class="text-gray-500 hover:text-gray-700">
      <svg
        class="w-4 h-4"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M6 18L18 6M6 6l12 12"
        ></path>
      </svg>
    </button>
  </div>

  <!-- Time Tracking Status -->
  <div id="tracking-status" class="mb-4">
    <div id="not-tracking" class="text-center py-4" style="display: none">
      <div class="text-gray-500 mb-3">
        <svg
          class="w-12 h-12 mx-auto mb-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
          ></path>
        </svg>
      </div>
      <p class="text-sm text-gray-600 mb-3">No active time tracking</p>
      <button
        id="start-tracking-btn"
        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium"
      >
        Start Tracking
      </button>
    </div>

    <div id="tracking-active" class="text-center py-4" style="display: none">
      <div class="text-green-500 mb-3">
        <svg
          class="w-12 h-12 mx-auto mb-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
          ></path>
        </svg>
      </div>
      <div class="mb-3">
        <div id="current-duration" class="text-2xl font-bold text-gray-800">
          00:00:00
        </div>
        <div id="activity-info" class="text-sm text-gray-600"></div>
      </div>
      <button
        id="stop-tracking-btn"
        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium"
      >
        Stop Tracking
      </button>
    </div>
  </div>

  <!-- Manual Time Tracking Form -->
  <div id="manual-tracking-form" class="border-t pt-4" style="display: none">
    <h4 class="text-sm font-medium text-gray-700 mb-3">
      Start Manual Tracking
    </h4>
    <form id="tracking-form">
      <div class="mb-3">
        <label class="block text-xs font-medium text-gray-600 mb-1"
          >Activity Type</label
        >
        <select
          id="activity-type"
          class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
          <option value="legal_research">Legal Research</option>
          <option value="client_consultation">Client Consultation</option>
          <option value="court_appearance">Court Appearance</option>
          <option value="document_preparation">Document Preparation</option>
          <option value="case_management">Case Management</option>
          <option value="meeting">Meeting</option>
          <option value="administrative">Administrative</option>
          <option value="training">Training</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="block text-xs font-medium text-gray-600 mb-1"
          >Description</label
        >
        <textarea
          id="description"
          rows="2"
          class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="What are you working on?"
        ></textarea>
      </div>
      <div class="mb-3">
        <label class="block text-xs font-medium text-gray-600 mb-1"
          >Client/Case (Optional)</label
        >
        <input
          type="text"
          id="client-case"
          class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Client name or case reference"
        />
      </div>
      <div class="flex space-x-2">
        <button
          type="submit"
          class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-md text-sm font-medium"
        >
          Start
        </button>
        <button
          type="button"
          id="cancel-tracking"
          class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-md text-sm font-medium"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>

  <!-- Quick Actions -->
  <div class="border-t pt-3 mt-3">
    <div class="flex space-x-2">
      <button
        id="toggle-form"
        class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-md text-xs font-medium"
      >
        Manual Track
      </button>
      <a
        href="{% url 'hr_management:time_sheets' %}"
        class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-md text-xs font-medium text-center"
      >
        View Timesheets
      </a>
    </div>
  </div>
</div>

<!-- Time Tracking JavaScript -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const widget = document.getElementById("time-tracking-widget");
    const toggleWidget = document.getElementById("toggle-widget");
    const notTracking = document.getElementById("not-tracking");
    const trackingActive = document.getElementById("tracking-active");
    const manualForm = document.getElementById("manual-tracking-form");
    const toggleForm = document.getElementById("toggle-form");
    const startBtn = document.getElementById("start-tracking-btn");
    const stopBtn = document.getElementById("stop-tracking-btn");
    const trackingForm = document.getElementById("tracking-form");
    const cancelBtn = document.getElementById("cancel-tracking");
    const currentDuration = document.getElementById("current-duration");
    const activityInfo = document.getElementById("activity-info");

    let trackingInterval = null;
    let startTime = null;

    // Load initial status
    loadTrackingStatus();

    // Toggle widget visibility
    toggleWidget.addEventListener("click", function () {
      widget.style.display = widget.style.display === "none" ? "block" : "none";
    });

    // Toggle manual form
    toggleForm.addEventListener("click", function () {
      manualForm.style.display =
        manualForm.style.display === "none" ? "block" : "none";
    });

    // Start tracking (automatic)
    startBtn.addEventListener("click", function () {
      startManualTracking();
    });

    // Stop tracking
    stopBtn.addEventListener("click", function () {
      stopManualTracking();
    });

    // Manual tracking form
    trackingForm.addEventListener("submit", function (e) {
      e.preventDefault();
      startManualTracking();
    });

    // Cancel manual tracking
    cancelBtn.addEventListener("click", function () {
      manualForm.style.display = "none";
    });

    function loadTrackingStatus() {
      fetch("/auth/api/tracking-status/")
        .then((response) => response.json())
        .then((data) => {
          if (data.is_tracking) {
            showTrackingActive(data);
          } else {
            showNotTracking();
          }
        })
        .catch((error) => {
          console.error("Error loading tracking status:", error);
          showNotTracking();
        });
    }

    function showNotTracking() {
      notTracking.style.display = "block";
      trackingActive.style.display = "none";
      manualForm.style.display = "none";
      if (trackingInterval) {
        clearInterval(trackingInterval);
        trackingInterval = null;
      }
    }

    function showTrackingActive(data) {
      notTracking.style.display = "none";
      trackingActive.style.display = "block";
      manualForm.style.display = "none";

      startTime = new Date(data.start_time);
      updateDuration();

      if (data.description) {
        activityInfo.textContent = `${data.description} (${data.activity_type})`;
      } else {
        activityInfo.textContent = data.is_manual
          ? "Manual tracking"
          : "Automatic tracking";
      }

      // Update duration every second
      if (trackingInterval) clearInterval(trackingInterval);
      trackingInterval = setInterval(updateDuration, 1000);
    }

    function updateDuration() {
      if (startTime) {
        const now = new Date();
        const diff = now - startTime;
        const hours = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);

        currentDuration.textContent = `${hours
          .toString()
          .padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds
          .toString()
          .padStart(2, "0")}`;
      }
    }

    function startManualTracking() {
      const activityType = document.getElementById("activity-type").value;
      const description = document.getElementById("description").value;
      const clientCase = document.getElementById("client-case").value;

      if (!description.trim()) {
        alert("Please enter a description for your work");
        return;
      }

      fetch("/auth/api/start-tracking/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          activity_type: activityType,
          description: description,
          client_case: clientCase,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            loadTrackingStatus();
            // Clear form
            document.getElementById("description").value = "";
            document.getElementById("client-case").value = "";
          } else {
            alert("Error: " + data.error);
          }
        })
        .catch((error) => {
          console.error("Error starting tracking:", error);
          alert("Error starting time tracking");
        });
    }

    function stopManualTracking() {
      fetch("/auth/api/stop-tracking/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            loadTrackingStatus();
            alert(
              `Time tracking stopped. Duration: ${data.duration_hours} hours`
            );
          } else {
            alert("Error: " + data.error);
          }
        })
        .catch((error) => {
          console.error("Error stopping tracking:", error);
          alert("Error stopping time tracking");
        });
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Auto-refresh status every 30 seconds
    setInterval(loadTrackingStatus, 30000);
  });
</script>
