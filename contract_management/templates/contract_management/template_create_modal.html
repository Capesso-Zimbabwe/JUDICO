{% extends 'components/modals/base-form-modal.html' %}

{% block modal_content %}
<div class="min-h-[500px] p-4">
    <form id="template-create-form" method="post" enctype="multipart/form-data" class="space-y-4">
        {% csrf_token %}
        
        <div>
            <label for="template_name" class="block text-sm font-medium text-gray-700 mb-1">Template Name *</label>
            <input type="text" id="template_name" name="name" required 
                   class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                   placeholder="Enter template name">
        </div>
        
        <div>
            <label for="template_contract_type" class="block text-sm font-medium text-gray-700 mb-1">Contract Type *</label>
            <select id="template_contract_type" name="contract_type" required 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <option value="">Select Contract Type</option>
                <option value="service_agreement">Service Agreement</option>
                <option value="retainer_agreement">Retainer Agreement</option>
                <option value="settlement_agreement">Settlement Agreement</option>
                <option value="employment_contract">Employment Contract</option>
                <option value="partnership_agreement">Partnership Agreement</option>
                <option value="nda">Non-Disclosure Agreement</option>
                <option value="licensing_agreement">Licensing Agreement</option>
                <option value="other">Other</option>
            </select>
        </div>
        
        <div>
            <label for="template_description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <textarea id="template_description" name="description" rows="3"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                      placeholder="Enter template description"></textarea>
        </div>
        
        <div>
            <label for="template_content" class="block text-sm font-medium text-gray-700 mb-1">Template Content *</label>
            <textarea id="template_content" name="template_content" rows="6" required
                      class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                      placeholder="Enter the template content with placeholders like {{client_name}}, {{contract_date}}, etc."></textarea>
            <div class="text-xs text-gray-500 mt-1">
                Available variables: {{client_name}}, {{lawyer_name}}, {{contract_date}}, {{start_date}}, {{end_date}}, {{contract_value}}, {{today_date}}
            </div>
        </div>
        
        <div>
            <label for="template_file" class="block text-sm font-medium text-gray-700 mb-1">Template File (Optional)</label>
            <input type="file" id="template_file" name="template_file" 
                   class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                   accept=".pdf,.doc,.docx">
            <div class="text-xs text-gray-500 mt-1">PDF, DOC, DOCX files accepted</div>
        </div>
        
        <div class="flex items-center">
            <input type="checkbox" id="template_is_active" name="is_active" checked
                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
            <label for="template_is_active" class="ml-2 block text-sm text-gray-700">
                Template is active and available for use
            </label>
        </div>
        
        <div class="flex gap-3 pt-4">
            <button type="submit" 
                    class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Create Template
            </button>
            <button type="button" onclick="closeCreateModal()"
                    class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                Cancel
            </button>
        </div>
    </form>
</div>

<script>
    // Use IIFE to avoid variable conflicts when modal is loaded multiple times
    (function() {
        // Check if already initialized to prevent duplicate event listeners
        if (window.templateCreateInitialized) return;
        window.templateCreateInitialized = true;

        // Handle template creation form submission
        const form = document.getElementById('template-create-form');
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                
                // Show loading state
                submitBtn.textContent = 'Creating...';
                submitBtn.disabled = true;
                
                fetch('{% url "contract_management:template_create" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => {
                    if (response.redirected) {
                        // Success - redirect to template list
                        window.location.href = response.url;
                    } else {
                        return response.text();
                    }
                })
                .then(html => {
                    if (html) {
                        // Check if there are form errors
                        if (html.includes('error') || html.includes('Error')) {
                            showNotification('Error creating template. Please check the form.', 'error');
                        } else {
                            showNotification('Template created successfully!', 'success');
                            // Close modal and reload page
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('An error occurred while creating the template.', 'error');
                })
                .finally(() => {
                    // Reset button state
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                });
            });
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Make closeModal available globally
        window.closeCreateModal = function() {
            // Close the modal using Flowbite
            const modal = document.getElementById('template-create-modal');
            if (modal) {
                const modalInstance = window.templateCreateModal;
                if (modalInstance) {
                    modalInstance.hide();
                }
            }
        };
    })();
</script>
{% endblock %}

{% block modal_title %}Create New Template{% endblock %}
